<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Census 2027 ¬∑ Malavalli Taluk</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Mukta:wght@400;600;700&family=Noto+Serif:wght@700&family=Noto+Sans+Kannada:wght@400;600;700&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100vh;background:#edf1f7;font-family:'Mukta',Arial,sans-serif;color:#1e293b}
.hidden{display:none!important}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px}
.hdr{background:linear-gradient(95deg,#1a3d72,#0d2448);border-bottom:3px solid #c9a227;position:sticky;top:0;z-index:300;box-shadow:0 2px 14px rgba(0,0,0,.3)}
.hdr-in{max-width:1280px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:14px}
.gov-seal{width:44px;height:44px;border-radius:50%;background:conic-gradient(#e2b93b 0%,#c9a227 30%,#a07818 60%,#c9a227 80%,#e2b93b 100%);display:flex;align-items:center;justify-content:center;font-size:21px;flex-shrink:0;box-shadow:0 0 0 3px rgba(201,162,39,.3)}
.hdr-title{flex:1}
.hdr-title h1{font-family:'Noto Serif',Georgia,serif;color:#fff;font-size:15px;font-weight:700}
.hdr-title p{color:#90b8e8;font-size:11px;margin-top:1px}
.hdr-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.hdr-chip{padding:3px 11px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid}
.chip-vao{background:rgba(59,130,246,.2);border-color:#60a5fa;color:#93c5fd}
.chip-sec{background:rgba(16,185,129,.2);border-color:#34d399;color:#6ee7b7}
.chip-adm{background:rgba(245,158,11,.2);border-color:#fbbf24;color:#fde68a}
.hdr-uname{color:#90b8e8;font-size:11px;font-weight:600;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn-hdr{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff;padding:5px 12px;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.btn-hdr:hover{background:rgba(255,255,255,.22)}
.page{max-width:1280px;margin:0 auto;padding:22px 18px}
/* LOGIN */
.login-wrap{max-width:440px;margin:44px auto}
.login-card{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(13,36,72,.2);overflow:hidden}
.login-top{background:linear-gradient(135deg,#1a3d72,#0d2448);padding:28px;text-align:center;border-bottom:3px solid #c9a227}
.login-ico{font-size:40px;margin-bottom:9px}
.login-top h2{font-family:'Noto Sans Kannada','Noto Serif',Georgia,serif;color:#fff;font-size:20px;line-height:1.35;font-weight:700}
.login-top p{color:#90b8e8;font-size:12px;margin-top:6px;line-height:1.6;font-family:'Noto Sans Kannada','Mukta',sans-serif}
.login-body{padding:26px}
.rtabs{display:flex;gap:4px;background:#f1f5f9;border-radius:9px;padding:4px;margin-bottom:20px}
.rtab{flex:1;padding:9px 6px;border:none;border-radius:6px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;background:transparent;color:#64748b;transition:all .2s}
.rtab.on{background:#1a3d72;color:#fff;box-shadow:0 2px 8px rgba(26,61,114,.28)}
.flbl{display:block;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.fgrp{margin-bottom:15px}
.fsel,.finp{width:100%;padding:10px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:14px;color:#1e293b;outline:none;background:#fff;transition:all .2s}
.fsel:focus,.finp:focus{border-color:#1a3d72;box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.err-msg{background:#fee2e2;border:1px solid #fca5a5;color:#dc2626;padding:9px 12px;border-radius:7px;font-size:13px;margin-bottom:14px}
.login-btn{width:100%;padding:12px;background:linear-gradient(135deg,#1a3d72,#0d4a8c);color:#fff;border:none;border-radius:9px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .22s}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(26,61,114,.3)}
.pwd-hint{text-align:center;font-size:11px;color:#94a3b8;margin-top:11px}
.pwd-wrap{position:relative}
.pwd-wrap .finp{padding-right:42px}
.eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#94a3b8;font-size:18px;line-height:1;padding:4px;user-select:none}
.eye-btn:hover{color:#1a3d72}
.url-banner{display:flex;align-items:flex-start;gap:10px;background:#fef9c3;border:1px solid #fde047;border-radius:10px;padding:13px 15px;margin-bottom:14px;font-size:12.5px;color:#854d0e;line-height:1.55}
.url-banner-inp{display:flex;gap:7px;margin-top:8px}
.url-banner-inp input{flex:1;padding:7px 10px;border:1.5px solid #fcd34d;border-radius:7px;font-family:inherit;font-size:12px;color:#1e293b;outline:none}
.url-banner-inp input:focus{border-color:#1a3d72;box-shadow:0 0 0 2px rgba(26,61,114,.1)}
.url-banner-inp button{padding:7px 14px;background:#1a3d72;color:#fff;border:none;border-radius:7px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
/* LAYOUT */
.layout{display:grid;grid-template-columns:262px 1fr;gap:18px;align-items:start}
/* MOBILE */
@media(max-width:740px){
  .layout{grid-template-columns:1fr}
  .page{padding:10px 10px}
  .hdr-in{padding:8px 12px;gap:8px}
  .gov-seal{width:36px;height:36px;font-size:17px}
  .hdr-title h1{font-size:12px}
  .hdr-title p{font-size:9px}
  .hdr-uname{max-width:80px;font-size:10px}
  .hdr-chip{font-size:9px;padding:2px 7px}
  .sb{position:static;margin-bottom:0}
  .sb-body{padding:10px 12px}
  .tbl-card{overflow-x:auto;max-height:none;border-radius:10px}
  table{min-width:0;width:100%}
  thead th{font-size:9px;padding:8px 6px;white-space:nowrap}
  tbody td{padding:7px 6px;font-size:12px}
  .ni{width:80px;font-size:12px;padding:5px 6px}
  .btn-sv,.btn-ed{font-size:11px;padding:5px 8px}
  .ctop{padding:13px 14px}
  .ctop h2{font-size:14px}
  .ctop p{font-size:11px}
  .login-wrap{margin:16px auto}
  .login-body{padding:18px}
  .atab{font-size:10px;padding:10px 4px}
  .apanel{padding:16px 14px}
  .admin-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .stat-card{padding:13px}
  .sc-val{font-size:22px}
  .setup-step{flex-direction:column;gap:10px}
  .url-row{flex-direction:column}
  .btn-url{width:100%}
  .guide-step{flex-direction:column;gap:8px;padding:13px}
  .sb-card{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);margin-bottom:0}
  .mobile-stats{display:grid!important;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
  .mobile-stat{text-align:center;padding:10px 6px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0}
  .mobile-stat-val{font-size:18px;font-weight:700;color:#1a3d72}
  .mobile-stat-lbl{font-size:9px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
  .sb{display:none}
  .mobile-topbar{display:flex!important;align-items:center;justify-content:space-between;background:#fff;border-radius:12px;padding:10px 14px;box-shadow:0 2px 12px rgba(0,0,0,.08);margin-bottom:10px}
  .mobile-topbar-name{font-weight:700;color:#1a3d72;font-size:13px}
  .mobile-topbar-role{font-size:10px;color:#64748b}
  .prog-table{font-size:11px}
  .prog-table th,.prog-table td{padding:6px 7px}
}
@media(min-width:741px){
  .mobile-topbar{display:none!important}
  .mobile-stats{display:none!important}
}
/* SIDEBAR */
.sb{background:#fff;border-radius:14px;box-shadow:0 4px 22px rgba(0,0,0,.09);overflow:hidden;position:sticky;top:72px}
.sb-head{background:linear-gradient(135deg,#1a3d72,#0d2448);padding:15px 17px;border-bottom:2px solid #c9a227}
.sb-head h3{font-family:'Noto Serif',Georgia,serif;color:#fff;font-size:14px}
.sb-head p{color:#90b8e8;font-size:11px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-body{padding:14px 15px}
.srow{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid #f1f5f9;font-size:12px}
.srow:last-child{border-bottom:none}
.slbl{color:#64748b;font-weight:600}
.sval{font-weight:700;color:#1e293b}
.sval.g{color:#15803d}.sval.a{color:#d97706}.sval.b{color:#1d4ed8}
.pb-row{display:flex;justify-content:space-between;font-size:11px;color:#64748b;margin:12px 0 4px}
.pbar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);border-radius:4px;transition:width .5s}
.sync-stat{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;margin-top:13px;font-size:12px;font-weight:700}
.ss-ok{background:#f0fdf4;color:#15803d;border:1px solid #86efac}
.ss-no{background:#fffbeb;color:#92400e;border:1px solid #fcd34d}
.ss-err{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.bdot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.bd-g{background:#16a34a}.bd-a{background:#f59e0b;animation:bl .8s infinite}.bd-r{background:#dc2626}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.2}}
.sb-btns{display:flex;flex-direction:column;gap:7px;margin-top:12px}
.sbbtn{padding:9px;border-radius:8px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;border:none;text-align:center}
.btn-lo{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}.btn-lo:hover{background:#991b1b;color:#fff}
.btn-retry{background:#fffbeb;color:#92400e;border:1px solid #fcd34d}.btn-retry:hover{background:#f59e0b;color:#fff}
/* CONTENT */
.content{display:flex;flex-direction:column;gap:14px}
.ctop{background:#fff;border-radius:14px;padding:17px 21px;box-shadow:0 4px 22px rgba(0,0,0,.09)}
.ctop h2{font-family:'Noto Serif',Georgia,serif;color:#1a3d72;font-size:17px}
.ctop p{color:#64748b;font-size:12px;margin-top:3px;line-height:1.5}
.spill{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:3px 11px;border-radius:20px;margin-top:9px}
.sp-ok{background:#dcfce7;color:#15803d}
.sp-no{background:#fee2e2;color:#991b1b}
.sp-warn{background:#fef9c3;color:#854d0e}
/* TABLE */
.tbl-card{background:#fff;border-radius:14px;box-shadow:0 4px 22px rgba(0,0,0,.09);overflow:auto;max-height:calc(100vh - 240px)}
table{width:100%;border-collapse:collapse;min-width:800px}
thead{background:linear-gradient(135deg,#1a3d72,#0d2448);position:sticky;top:0;z-index:5}
thead th{padding:11px 10px;text-align:left;font-size:10px;font-weight:700;color:#90b8e8;text-transform:uppercase;letter-spacing:.5px;border-right:1px solid rgba(255,255,255,.07);white-space:nowrap}
thead th:last-child{border-right:none}
tbody td{padding:9px 10px;font-size:13px;color:#334155;vertical-align:middle;border-bottom:1px solid #e8edf5}
tr.vrow{background:#fff;transition:background .1s}
tr.vrow:hover{background:#f8fafc}
tr.vrow.done{background:#f0fdf4}
tr.drow{background:#faf7ff}
tr.drow:hover{background:#f3eeff}
tr.drow.done{background:#f0fdf4}
.sno-c{background:#e2e8f0;color:#475569;width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.dk-arr{color:#a78bfa;font-size:16px;font-weight:900}
.vname{font-weight:700;color:#1e293b;font-size:13px}
.dk-hint{font-size:10px;color:#a78bfa;margin-top:1px}
.dk-rl{display:flex;align-items:center;gap:7px}
.dk-dl{border-top:2px dashed #c4b5fd;width:14px;flex-shrink:0}
.dk-nm{font-weight:700;color:#5b21b6;font-size:13px}
.dk-ch{background:#ede9fe;color:#5b21b6;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:.4px;margin-left:3px}
.gp-ch{background:#dbeafe;color:#1d4ed8;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;white-space:nowrap}
.cm{font-family:'Courier New',monospace;font-size:11px;color:#94a3b8}
.ni{width:115px;padding:7px 9px;border:1.5px solid #e2e8f0;border-radius:7px;font-family:inherit;font-size:13px;color:#1e293b;text-align:right;outline:none;transition:all .2s;-moz-appearance:textfield;appearance:textfield}
.ni::-webkit-outer-spin-button,.ni::-webkit-inner-spin-button{-webkit-appearance:none}
.ni:focus{border-color:#1a3d72;box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.ni.ok{border-color:#16a34a;background:#f0fdf4}
.act{display:flex;align-items:center;gap:6px}
.rdot{width:8px;height:8px;border-radius:50%;display:none;flex-shrink:0}
.rdot.v{display:inline-block}
.rd-spin{background:#f59e0b;animation:bl .8s infinite}
.rd-ok{background:#16a34a}
.rd-err{background:#dc2626}
.btn-sv{padding:5px 13px;background:#1a3d72;color:#fff;border:none;border-radius:7px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.btn-sv:hover{background:#0d4a8c}
.btn-ed{padding:5px 11px;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;border-radius:7px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.btn-ed:hover{background:#1e40af;color:#fff}
/* ADMIN */
.admin-tabs{display:flex;gap:0;background:#fff;border-radius:14px 14px 0 0;overflow:hidden;box-shadow:0 -2px 8px rgba(0,0,0,.05)}
.atab{flex:1;padding:13px 8px;border:none;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;background:#f8fafc;color:#64748b;border-bottom:3px solid transparent;transition:all .2s;text-align:center}
.atab.on{background:#fff;color:#1a3d72;border-bottom-color:#1a3d72}
.atab:hover:not(.on){background:#f1f5f9}
.apanel{background:#fff;border-radius:0 0 14px 14px;box-shadow:0 4px 22px rgba(0,0,0,.09);padding:24px}
.admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:13px;margin-bottom:22px}
.stat-card{background:linear-gradient(135deg,#1a3d72,#0d2448);color:#fff;border-radius:12px;padding:17px;position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;right:-10px;bottom:-10px;width:65px;height:65px;border-radius:50%;background:rgba(255,255,255,.07)}
.sc-ico{font-size:26px;margin-bottom:7px}
.sc-val{font-size:27px;font-weight:700;line-height:1}
.sc-lbl{font-size:11px;color:#90b8e8;margin-top:4px;font-weight:600}
.sc-bar{height:4px;background:rgba(255,255,255,.2);border-radius:2px;margin-top:10px;overflow:hidden}
.sc-fill{height:100%;background:#c9a227;border-radius:2px;transition:width .5s}
.sec-title{font-family:'Noto Serif',Georgia,serif;color:#1a3d72;font-size:15px;font-weight:700;margin-bottom:13px;display:flex;align-items:center;gap:7px}
.prog-table{width:100%;border-collapse:collapse}
.prog-table th{background:#f1f5f9;padding:9px 11px;text-align:left;font-size:10.5px;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid #e2e8f0}
.prog-table td{padding:9px 11px;font-size:12.5px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.prog-table tr:hover td{background:#f8fafc}
.mini-bar{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;min-width:80px}
.mini-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#16a34a,#22c55e)}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700}
.b-done{background:#dcfce7;color:#15803d}
.b-part{background:#fef9c3;color:#854d0e}
.b-none{background:#f1f5f9;color:#475569}
/* SETUP */
.setup-step{display:flex;gap:14px;margin-bottom:22px;padding-bottom:22px;border-bottom:1px dashed #e2e8f0}
.setup-step:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.step-n{width:32px;height:32px;background:#1a3d72;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.step-body h4{font-size:14px;font-weight:700;color:#1e293b;margin-bottom:5px}
.step-body p{font-size:12.5px;color:#475569;line-height:1.65}
.step-body a{color:#1a3d72;font-weight:700}
.step-body code{background:#f1f5f9;padding:2px 5px;border-radius:3px;font-family:'Courier New',monospace;font-size:11px;color:#1a3d72}
.code-wrap{position:relative;margin-top:10px}
.code-blk{background:#0f172a;color:#e2e8f0;border-radius:10px;padding:14px;font-family:'Courier New',monospace;font-size:11px;line-height:1.65;max-height:230px;overflow:auto;white-space:pre}
.cp-btn{position:absolute;top:8px;right:8px;background:#1a3d72;color:#fff;border:none;padding:5px 12px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.cp-btn.done{background:#15803d}
.url-row{display:flex;gap:8px;margin-top:10px}
.url-inp{flex:1;padding:10px 12px;border:1.5px solid #e2e8f0;border-radius:7px;font-family:inherit;font-size:13px;color:#1e293b;outline:none;transition:all .2s}
.url-inp:focus{border-color:#1a3d72;box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.url-inp.ok{border-color:#16a34a;background:#f0fdf4}
.btn-url{padding:10px 18px;background:#1a3d72;color:#fff;border:none;border-radius:7px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer}
.btn-url:hover{background:#0d4a8c}
.btn-test{padding:7px 16px;background:#f0f9ff;color:#0369a1;border:1px solid #bae6fd;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:8px}
.btn-test:hover{background:#0369a1;color:#fff}
.test-ok{background:#f0fdf4;color:#15803d;border:1px solid #86efac;padding:9px 12px;border-radius:7px;font-size:12px;font-weight:700;margin-top:8px}
.test-err{background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;padding:9px 12px;border-radius:7px;font-size:12px;font-weight:700;margin-top:8px}
/* UPLOAD */
.upload-zone{border:2px dashed #cbd5e1;border-radius:12px;padding:34px;text-align:center;cursor:pointer;transition:all .2s;background:#f8fafc;margin-bottom:16px}
.upload-zone:hover,.upload-zone.drag{border-color:#1a3d72;background:#eff6ff}
.upload-ico{font-size:40px;margin-bottom:10px}
.upload-zone h3{font-size:15px;font-weight:700;color:#1e293b;margin-bottom:5px}
.upload-zone p{font-size:12px;color:#64748b;line-height:1.6}
.csv-fmt{background:#f1f5f9;border-radius:8px;padding:13px;margin-top:14px}
.csv-fmt h4{font-size:11px;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.4px;margin-bottom:7px}
.csv-fmt code{display:block;font-family:'Courier New',monospace;font-size:11px;color:#1a3d72;background:#fff;border:1px solid #e2e8f0;border-radius:5px;padding:8px 10px;white-space:pre;overflow:auto}
.btn-pri{padding:10px 22px;background:linear-gradient(135deg,#1a3d72,#0d4a8c);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer}
.btn-pri:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(26,61,114,.3)}
.btn-sec{padding:10px 22px;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer}
.preview-tbl{width:100%;border-collapse:collapse;font-size:12px}
.preview-tbl th{background:#f1f5f9;padding:7px 10px;text-align:left;font-weight:700;color:#475569;border-bottom:1px solid #e2e8f0;font-size:10.5px;text-transform:uppercase}
.preview-tbl td{padding:6px 10px;border-bottom:1px solid #f1f5f9;color:#334155}
/* GUIDE */
.guide-step{display:flex;gap:14px;margin-bottom:16px;padding:17px;background:#f8fafc;border-radius:12px;border-left:4px solid #1a3d72}
.guide-n{width:34px;height:34px;background:#1a3d72;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0}
.guide-body h4{font-size:14px;font-weight:700;color:#1a3d72;margin-bottom:5px}
.guide-body p{font-size:12.5px;color:#475569;line-height:1.65}
.guide-body code{background:#e8edf5;padding:2px 6px;border-radius:4px;font-family:'Courier New',monospace;font-size:11px;color:#1a3d72}
.note-box{background:#fef9c3;border:1px solid #fde047;border-radius:8px;padding:12px 16px;margin:14px 0;font-size:12.5px;color:#854d0e;line-height:1.6}
.info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin:14px 0;font-size:12.5px;color:#1e40af;line-height:1.6}
.tag{display:inline-flex;align-items:center;gap:5px;background:#dcfce7;color:#15803d;border:1px solid #86efac;padding:3px 10px;border-radius:20px;font-size:11.5px;font-weight:700;margin:3px}
/* FOOTER */
.footer{text-align:center;padding:24px 16px 16px;margin-top:12px;border-top:1px solid #dce3ed;line-height:1.9}
.footer .f1{font-family:'Noto Serif',Georgia,serif;font-size:13px;font-weight:700;color:#1a3d72}
.footer .f2{font-size:12px;color:#475569}.footer .f2 strong{color:#1a3d72}
.footer .f3{font-size:11px;color:#94a3b8;margin-top:2px}
/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:700;box-shadow:0 8px 32px rgba(0,0,0,.25);z-index:9999;pointer-events:none;opacity:0;transform:translateY(14px);transition:all .25s;max-width:320px;display:flex;align-items:center;gap:8px}
#toast.show{opacity:1;transform:translateY(0)}
#toast.tok{background:#15803d;color:#fff}
#toast.tbad{background:#dc2626;color:#fff}
#toast.tinfo{background:#1a3d72;color:#fff}
#toast.twarn{background:#d97706;color:#fff}
</style>
</head>
<body>
<!-- HEADER -->
<header class="hdr">
  <div class="hdr-in">
    <div class="gov-seal">üèõÔ∏è</div>
    <div class="hdr-title">
      <h1>Census 2027 ‚Äî Village Population Data Entry</h1>
      <p>Malavalli Taluk ¬∑ Mandya District ¬∑ Karnataka Government</p>
    </div>
    <div class="hdr-right">
      <div id="hdr-sess" style="display:none;align-items:center;gap:8px">
        <span id="hdr-chip" class="hdr-chip chip-vao"></span>
        <span id="hdr-nm" class="hdr-uname"></span>
      </div>
    </div>
  </div>
</header>

<!-- LOGIN PAGE -->
<div class="page" id="pg-login">
  <div class="login-wrap">
    <div class="login-card">
      <div class="login-top">
        <div class="login-ico">üîê</div>
        <h2>‡≤ú‡≤®‡≤ó‡≤£‡≤§‡≤ø 2027</h2>
        <p>‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤ú‡≤®‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ï‡≥Å‡≤ü‡≥Å‡≤Ç‡≤¨/‡≤Æ‡≤®‡≥Ü‡≤ó‡≤≥ ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü‡≤Ø<br>‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø ‡≤∏‡≤Ç‡≤ó‡≥ç‡≤∞‡≤π‡≤£ ‡≤™‡≥ã‡≤∞‡≥ç‡≤ü‡≤≤‡≥ç<br>‡≤Æ‡≤≥‡≤µ‡≤≥‡≥ç‡≤≥‡≤ø ‡≤§‡≤æ‡≤≤‡≥ç‡≤≤‡≥Ç‡≤ï‡≥Å ¬∑ ‡≤Æ‡≤Ç‡≤°‡≥ç‡≤Ø ‡≤ú‡≤ø‡≤≤‡≥ç‡≤≤‡≥Ü</p>
      </div>
      <div class="login-body">
        <div class="rtabs">
          <button class="rtab on" id="tab-vao" onclick="setTab('vao')">üë§ VAO</button>
          <button class="rtab" id="tab-sec" onclick="setTab('secretary')">üè¢ Secretary</button>
          <button class="rtab" id="tab-adm" onclick="setTab('admin')">‚öô Admin</button>
        </div>
        <div class="err-msg hidden" id="login-err"></div>
        <div class="fgrp" id="name-grp">
          <label class="flbl" id="name-lbl">VAO Name</label>
          <select class="fsel" id="name-sel"><option value="">-- Select --</option></select>
        </div>
        <div class="fgrp">
          <label class="flbl">‡≤ó‡≥Å‡≤™‡≥ç‡≤§‡≤™‡≤¶ / Password</label>
          <div class="pwd-wrap">
            <input class="finp" type="password" id="pwd" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/>
            <button class="eye-btn" type="button" onclick="togglePwd()" id="eye-btn" title="Show/Hide password">üëÅ</button>
          </div>
        </div>
        <button class="login-btn" onclick="doLogin()">Login ‚Üí</button>
      </div>
    </div>
  </div>
  <div style="text-align:center;margin-top:22px;padding-bottom:10px">
    <div style="font-family:'Noto Serif',Georgia,serif;font-size:13px;font-weight:700;color:#1a3d72">Census 2027 ‚Äî Village Population Data Entry</div>
    <div style="font-size:12px;color:#64748b;margin-top:4px">Designed &amp; Developed by <strong style="color:#1a3d72">Gangadhar</strong><br>Statistical Inspector, Taluk Office Malavalli, Mandya</div>
    <div style="font-size:11px;color:#94a3b8;margin-top:3px">¬© 2027 ¬∑ For official government use only</div>
  </div>
</div>

<!-- ENTRY PAGE (VAO / Secretary) -->
<div class="page hidden" id="pg-entry">
  <!-- Mobile topbar (hidden on desktop via CSS) -->
  <div class="mobile-topbar" id="mob-topbar" style="display:none">
    <div>
      <div class="mobile-topbar-name" id="mob-name"></div>
      <div class="mobile-topbar-role" id="mob-role"></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span id="mob-sync" style="font-size:11px;font-weight:700"></span>
      <button onclick="doLogout()" style="background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;border-radius:7px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">Logout</button>
    </div>
  </div>
  <!-- Mobile mini-stats (hidden on desktop) -->
  <div class="mobile-stats" id="mob-stats" style="display:none">
    <div class="mobile-stat"><div class="mobile-stat-val" id="mob-v">0</div><div class="mobile-stat-lbl">‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ‡≤ó‡≤≥‡≥Å</div></div>
    <div class="mobile-stat"><div class="mobile-stat-val" id="mob-done">0</div><div class="mobile-stat-lbl">‡≤™‡≥Ç‡≤∞‡≥ç‡≤£</div></div>
    <div class="mobile-stat"><div class="mobile-stat-val" id="mob-pct">0%</div><div class="mobile-stat-lbl">Progress</div></div>
  </div>
  <div class="layout">
    <div class="sb">
      <div class="sb-head"><h3 id="sb-title">VAO Panel</h3><p id="sb-nm"></p></div>
      <div class="sb-body">
        <div class="srow"><span class="slbl">Role</span><span class="sval b" id="sb-role"></span></div>
        <div class="srow"><span class="slbl">Villages</span><span class="sval" id="sb-v"></span></div>
        <div class="srow"><span class="slbl">Total Rows</span><span class="sval" id="sb-t"></span></div>
        <div class="srow"><span class="slbl">Completed</span><span class="sval" id="sb-done"></span></div>
        <div class="srow"><span class="slbl">Synced ‚òÅ</span><span class="sval" id="sb-sync"></span></div>
        <div class="pb-row"><span>Progress</span><span id="pb-pct">0%</span></div>
        <div class="pbar"><div class="pfill" id="pfill"></div></div>
        <div class="sync-stat ss-no" id="ss-blk"><span class="bdot bd-a"></span><span id="ss-txt">Not connected</span></div>
        <div class="sb-btns">
          <button class="sbbtn btn-retry hidden" id="btn-retry" onclick="retryFailed()">‚Ü© Retry Failed Syncs</button>
          <button class="sbbtn btn-lo" onclick="doLogout()">‚Üê Logout</button>
        </div>
      </div>
    </div>
    <div class="content">
      <div id="url-setup-banner" class="url-banner hidden">
        <div>
          <strong>‚ö† Google Sheets sync not configured on this device.</strong><br>
          Enter the Web App URL provided by your Admin to enable automatic sync:
          <div class="url-banner-inp">
            <input type="text" id="banner-url-inp" placeholder="https://script.google.com/macros/s/‚Ä¶/exec"/>
            <button onclick="saveBannerUrl()">Save &amp; Enable Sync</button>
          </div>
        </div>
      </div>
      <div class="ctop">
        <h2 id="ct-title">Data Entry</h2>
        <p id="ct-sub"></p>
        <span class="spill sp-no hidden" id="pill-no">‚ö† Google Sheets not configured ‚Äî Admin must set up</span>
        <span class="spill sp-ok hidden" id="pill-ok">‚úì Connected ‚Äî every Save auto-syncs to Google Sheets</span>
        <span class="spill sp-warn hidden" id="pill-warn">‚ö† Some rows failed to sync ‚Äî use Retry in sidebar</span>
      </div>
      
  const url = resolveSheetURL();
  if(!url) return;

  try{
    const res = await fetch(url,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'getUserData',
        user:user
      })
    });

    const json = await res.json();

    if(json.success){
      S.rows = {};
      json.rows.forEach(r=>{
        S.rows[r["Row ID"]] = {
          rowId:r["Row ID"],
          popVAO:r["Population (VAO)"] || '',
          hhVAO:r["House Holds (VAO)"] || ''
        };
        S.syncSt[r["Row ID"]] = 'ok';
      });

      saveState();
      renderTable();
      updateSyncUI();
    }

  }catch(e){
    console.warn("Fetch failed",e);
  }
}
      <div class="tbl-card">
        <table>
          <thead><tr>
            <th style="width:30px">#</th><th>Code</th><th id="th2">‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ‡≤¶/‡≤¶‡≤æ‡≤ñ‡≤≤‡≥Ü ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å</th>
            <th id="th3">‡≤ó‡≥ç‡≤∞‡≤æ.‡≤™‡≤Ç ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å</th><th id="th4">‡≤á‡≤Ç‡≤¶‡≤ø‡≤® ‡≤ú‡≤®‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü (‡≤ó‡≥ç‡≤∞‡≤æ.‡≤≤‡≥Ü)</th><th id="th5">‡≤Æ‡≤®‡≥Ü‡≤ó‡≤≥/‡≤ï‡≥Å‡≤ü‡≥Å‡≤Ç‡≤¨‡≤ó‡≤≥ ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü(‡≤ó‡≥ç‡≤∞‡≤æ.‡≤≤‡≥Ü)</th>
            <th style="width:110px">Action</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="f1">Census 2027 ‚Äî Village Population Data Entry System</div>
    <div class="f2">Designed &amp; Developed by <strong>Gangadhar</strong>, Statistical Inspector<br>Taluk Office Malavalli, Mandya</div>
    <div class="f3">¬© 2027 All rights reserved ¬∑ For official government use only</div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div class="page hidden" id="pg-admin">
  <div class="admin-tabs" style="display:flex;align-items:stretch">
    <button class="atab on" id="at-0" onclick="showAdminTab(0)">üìä Progress</button>
    <button class="atab" id="at-1" onclick="showAdminTab(1)">‚òÅ Sheets</button>
    <button class="atab" id="at-2" onclick="showAdminTab(2)">üì§ Upload</button>
    <button class="atab" id="at-3" onclick="showAdminTab(3)">üöÄ Hosting</button>
    <button onclick="doLogout()" style="background:#fee2e2;color:#991b1b;border:none;border-left:1px solid #fca5a5;padding:10px 16px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;border-radius:0 14px 0 0">‚Üê Logout</button>
  </div>

  <!-- TAB 0: PROGRESS -->
  <div class="apanel" id="ap-0">
    <div class="admin-grid" id="admin-cards"></div>
    <div class="sec-title">üìã VAO-wise Completion Status</div>
    <div style="overflow:auto;margin-bottom:22px">
      <table class="prog-table">
        <thead><tr><th>#</th><th>VAO Name</th><th>Villages</th><th>VAO Completed</th><th>Sec Verified</th><th>Progress</th><th>Status</th></tr></thead>
        <tbody id="vao-tbody"></tbody>
      </table>
    </div>
    <div class="sec-title">üèò Village-level Detail</div>
    <div style="overflow:auto;max-height:360px">
      <table class="prog-table">
        <thead><tr><th>#</th><th>Code</th><th>Village</th><th>VAO</th><th>GP</th><th>Pop (VAO)</th><th>HH (VAO)</th><th>Pop (Sec)</th><th>HH (Sec)</th><th>Sync</th></tr></thead>
        <tbody id="vil-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB 1: SHEETS SETUP -->
  <div class="apanel hidden" id="ap-1">
    <div class="sec-title">‚òÅ Google Sheets Integration ‚Äî 4-Step Setup</div>
    <div class="setup-step">
      <div class="step-n">1</div>
      <div class="step-body">
        <h4>Create a Google Sheet</h4>
        <p>Go to <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> ‚Üí Click <strong>Ôºã Blank</strong><br>
        Rename it: <strong>"Census 2027 Malavalli Taluk"</strong><br>
        The app auto-creates all headers and formatting on first save ‚Äî nothing manual needed.</p>
      </div>
    </div>
    <div class="setup-step">
      <div class="step-n">2</div>
      <div class="step-body">
        <h4>Open Apps Script &amp; Paste the Code Below</h4>
        <p>In the sheet ‚Üí click <strong>Extensions</strong> menu ‚Üí <strong>Apps Script</strong><br>
        Delete all existing code in the editor, then paste:</p>
        <div class="code-wrap">
          <pre class="code-blk" id="script-box"></pre>
          <button class="cp-btn" id="cp-btn" onclick="copyScript()">Copy</button>
        </div>
      </div>
    </div>
    <div class="setup-step">
      <div class="step-n">3</div>
      <div class="step-body">
        <h4>Deploy as Web App</h4>
        <p>
          In Apps Script ‚Üí Click <strong>Deploy</strong> button (top right) ‚Üí <strong>New deployment</strong><br>
          ‚Üí Click the <strong>gear icon ‚öô</strong> ‚Üí Select <strong>Web app</strong><br>
          ‚Üí Execute as: <strong>Me</strong><br>
          ‚Üí Who has access: <strong>Anyone</strong> ‚Üê <em>This is the critical setting</em><br>
          ‚Üí Click <strong>Deploy</strong> ‚Üí Click <strong>Authorize access</strong> ‚Üí Choose your Google account ‚Üí <strong>Allow</strong><br>
          ‚Üí <strong>Copy the Web App URL</strong> (starts with <code>https://script.google.com/macros/s/‚Ä¶/exec</code>)
        </p>
      </div>
    </div>
    <div class="setup-step">
      <div class="step-n">4</div>
      <div class="step-body">
        <h4>Paste URL, Verify it Works, then Save</h4>
        <p style="margin-bottom:10px">The URL looks like:<br>
        <code>https://script.google.com/macros/s/AKfy‚Ä¶xyz/exec</code><br>
        ‚ö† Do <strong>NOT</strong> copy the editor URL (contains <code>/edit</code>). Get it from Deploy ‚Üí Manage deployments.</p>

        <div class="url-row">
          <input class="url-inp" type="text" id="url-inp" placeholder="https://script.google.com/macros/s/‚Ä¶/exec" oninput="onUrlInput()"/>
          <button class="btn-url" onclick="saveUrl()">Save URL</button>
        </div>

        <!-- STEP A: open in tab -->
        <div id="test-box" style="margin-top:14px;padding:14px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px">
          <div style="font-size:13px;font-weight:700;color:#1e40af;margin-bottom:8px">üîç Step A ‚Äî Verify the script works (30 seconds)</div>
          <p style="font-size:12.5px;color:#1e40af;line-height:1.7;margin-bottom:10px">
            Browsers block automatic connection tests to Google's servers (CORS restriction).<br>
            Instead: click the button below ‚Äî it opens your URL in a new tab.<br>
            <strong>What you should see in the new tab:</strong> <code style="background:#dbeafe;padding:2px 6px;border-radius:3px">{"ok":true,"msg":"Census 2027 Malavalli ‚Äî Connected successfully!"}</code>
          </p>
          <button class="btn-pri" id="open-tab-btn" onclick="openInTab()" style="font-size:12px;padding:8px 18px;opacity:.4;cursor:not-allowed" disabled>üåê Open URL in New Tab to Verify ‚Üí</button>
          <span style="font-size:11px;color:#64748b;margin-left:8px" id="tab-hint">Paste URL above first</span>
        </div>

        <!-- STEP B: what to do based on what they see -->
        <div style="margin-top:12px;padding:14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px">
          <div style="font-size:13px;font-weight:700;color:#1e293b;margin-bottom:10px">üìã Step B ‚Äî What do you see in the new tab?</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="padding:10px 13px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px">
              <div style="font-size:12.5px;font-weight:700;color:#15803d;margin-bottom:4px">‚úÖ I see JSON text starting with {"ok":true ‚Ä¶}</div>
              <div style="font-size:12px;color:#166534;margin-bottom:8px">Your Apps Script is deployed correctly. Click below to confirm and save.</div>
              <button class="btn-pri" onclick="markConnected()" style="font-size:12px;padding:7px 16px;background:#15803d">‚úì Mark as Connected &amp; Save URL</button>
            </div>
            <div style="padding:10px 13px;background:#fef9c3;border:1px solid #fde047;border-radius:8px">
              <div style="font-size:12.5px;font-weight:700;color:#854d0e;margin-bottom:4px">‚ö† I see a Google login page</div>
              <div style="font-size:12px;color:#713f12;line-height:1.6">Your deployment has <strong>"Who has access"</strong> set incorrectly.<br>
              Fix: In Apps Script ‚Üí Deploy ‚Üí <strong>New deployment</strong> (not edit) ‚Üí Web app ‚Üí Execute as: Me ‚Üí Who has access: <strong>Anyone</strong> (NOT "Anyone with Google account") ‚Üí Deploy ‚Üí Authorize ‚Üí copy new URL.</div>
            </div>
            <div style="padding:10px 13px;background:#fee2e2;border:1px solid #fca5a5;border-radius:8px">
              <div style="font-size:12.5px;font-weight:700;color:#991b1b;margin-bottom:4px">‚ùå I see "Script function not found" or an error page</div>
              <div style="font-size:12px;color:#7f1d1d;line-height:1.6">The Apps Script code was not pasted correctly.<br>
              Fix: In Apps Script editor ‚Üí select all (Ctrl+A) ‚Üí delete ‚Üí paste the copied code again ‚Üí Save (Ctrl+S) ‚Üí then <strong>create a New deployment</strong> (you must redeploy after code changes, editing the existing deployment does NOT update it).</div>
            </div>
            <div style="padding:10px 13px;background:#f3e8ff;border:1px solid #d8b4fe;border-radius:8px">
              <div style="font-size:12.5px;font-weight:700;color:#6b21a8;margin-bottom:4px">üîÑ Tab opened but shows a blank page or redirects</div>
              <div style="font-size:12px;color:#581c87;line-height:1.6">Try opening the URL directly: copy the URL from the field above ‚Üí open a new browser tab ‚Üí paste ‚Üí press Enter. Wait up to 30 seconds for the first response (Apps Script "wakes up" slowly on first call).</div>
            </div>
          </div>
        </div>

        <div id="url-saved-msg" class="hidden" style="margin-top:10px;padding:10px 14px;background:#f0fdf4;border:1px solid #86efac;border-radius:8px;color:#15803d;font-size:13px;font-weight:700">
          ‚úÖ URL saved and verified ‚Äî all VAOs and Secretaries will now auto-sync every Save to Google Sheets
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 2: UPLOAD DATA -->
  <div class="apanel hidden" id="ap-2">
    <div class="sec-title">üì§ Upload Village Data from Excel / CSV</div>
    <p style="font-size:13px;color:#475569;margin-bottom:16px;line-height:1.6">
      Upload your own village list to replace the built-in 202 villages. All VAO and Secretary logins will use the new data.
    </p>
    <div class="upload-zone" id="drop-zone"
      onclick="document.getElementById('file-inp').click()"
      ondragover="event.preventDefault();this.classList.add('drag')"
      ondragleave="this.classList.remove('drag')"
      ondrop="handleDrop(event)">
      <div class="upload-ico">üìÇ</div>
      <h3>Click to select file or drag &amp; drop</h3>
      <p>Supported: <strong>.csv</strong> (recommended) or <strong>.xlsx / .xls</strong><br>Maximum: 1000 villages</p>
    </div>
    <input type="file" id="file-inp" accept=".csv,.xlsx,.xls" onchange="handleFile(this)" style="display:none"/>
    <div class="csv-fmt">
      <h4>Required Column Format (first row = headers)</h4>
      <code id="csv-sample"></code>
      <p style="font-size:11.5px;color:#64748b;margin-top:8px">
        üí° <strong>Tip:</strong> Open your Excel file ‚Üí File ‚Üí Save As ‚Üí CSV (Comma delimited) ‚Üí Upload that CSV file here.<br>
        For multiple Dakale Gramas use format: <code>1)Name1 2)Name2 3)Name3</code> ‚Äî single name or leave blank is also fine.
      </p>
    </div>
    <div class="hidden" id="upload-preview">
      <div class="sec-title" style="margin-top:20px">Preview (first 5 rows)</div>
      <div style="overflow:auto"><table class="preview-tbl" id="prev-tbl"></table></div>
      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn-pri" onclick="applyUpload()">‚úì Apply This Data</button>
        <button class="btn-sec" onclick="cancelUpload()">‚úï Cancel</button>
      </div>
    </div>
    <div style="margin-top:18px">
      <button class="btn-sec" style="font-size:12px" onclick="resetToDefault()">‚Ü© Reset to Built-in Default (202 villages)</button>
    </div>
  </div>

  <!-- TAB 3: HOSTING GUIDE -->
  <div class="apanel hidden" id="ap-3">
    <div class="sec-title">üöÄ Host on GitHub Pages ‚Äî Free, No Commands Needed</div>
    <div class="info-box">
      <strong>What you get after following these steps:</strong> A live website working on any phone/computer, handling 100+ users at once, costs ‚Çπ0/month, always online, no server, no maintenance.
      <br><span class="tag">‚úì Free forever</span><span class="tag">‚úì No server</span><span class="tag">‚úì Works on mobile</span><span class="tag">‚úì 100+ simultaneous users</span><span class="tag">‚úì Zero maintenance</span>
    </div>

    <div class="guide-step">
      <div class="guide-n">1</div>
      <div class="guide-body">
        <h4>Download This App File</h4>
        <p>This single HTML file is the complete app ‚Äî no other files are needed.<br>Click the button below to save it to your computer.</p>
        <button class="btn-pri" style="margin-top:10px;font-size:12px" onclick="downloadSelf()">‚¨á Download Updated App (with Sheet URL baked in)</button>
          <p style="font-size:11.5px;color:#475569;margin-top:8px;line-height:1.6">
            üí° <strong>After setting up Google Sheets (tab ‚òÅ Sheets Setup):</strong> Click this button to download the app with your Sheet URL already built-in. When you re-upload this file to GitHub, ALL users on ALL devices will sync automatically ‚Äî no manual setup needed for anyone.
          </p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">2</div>
      <div class="guide-body">
        <h4>Create a Free GitHub Account</h4>
        <p>Open <strong>github.com</strong> in your browser ‚Üí Click <strong>Sign up</strong> (top right)<br>
        Enter your email ‚Üí Create a password ‚Üí Choose a username (example: <code>malavalli-census</code>)<br>
        Verify your email address ‚Üí Account is ready to use.</p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">3</div>
      <div class="guide-body">
        <h4>Create a New Repository</h4>
        <p>After logging in to github.com:<br>
        ‚Üí Click the <strong>green "New" button</strong> (top-left area)<br>
        ‚Üí Repository name: <code>census-2027</code> (use lowercase, no spaces)<br>
        ‚Üí Select <strong>Public</strong> ‚Üê required for free hosting<br>
        ‚Üí Check <strong>"Add a README file"</strong><br>
        ‚Üí Click <strong>"Create repository"</strong></p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">4</div>
      <div class="guide-body">
        <h4>Upload the HTML File</h4>
        <p>You are now inside your new repository:<br>
        ‚Üí Click <strong>"Add file"</strong> button ‚Üí select <strong>"Upload files"</strong><br>
        ‚Üí Drag <code>census2027.html</code> into the upload box (or click "choose your files")<br>
        ‚Üí Scroll down ‚Üí Click <strong>"Commit changes"</strong> (green button)</p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">5</div>
      <div class="guide-body">
        <h4>Rename the File to index.html</h4>
        <p>GitHub Pages needs the main file to be named exactly <code>index.html</code>:<br>
        ‚Üí Click on <code>census2027.html</code> in the file list<br>
        ‚Üí Click the <strong>pencil icon ‚úè "Edit this file"</strong> (top-right of the file view)<br>
        ‚Üí At the very top, change the filename from <code>census2027.html</code> to <code>index.html</code><br>
        ‚Üí Scroll down ‚Üí Click <strong>"Commit changes"</strong> ‚Üí Click <strong>"Commit changes"</strong> again in the popup</p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">6</div>
      <div class="guide-body">
        <h4>Enable GitHub Pages</h4>
        <p>‚Üí Click the <strong>"Settings"</strong> tab (last tab in your repository)<br>
        ‚Üí In the left sidebar, scroll down and click <strong>"Pages"</strong><br>
        ‚Üí Under "Source" ‚Üí click the dropdown showing "None" ‚Üí select <strong>"main"</strong><br>
        ‚Üí Leave the second dropdown as <strong>"/ (root)"</strong><br>
        ‚Üí Click <strong>"Save"</strong><br>
        A banner appears: <em>"Your site is ready to be published at https://‚Ä¶"</em></p>
      </div>
    </div>

    <div class="guide-step">
      <div class="guide-n">7</div>
      <div class="guide-body">
        <h4>Wait 2 Minutes ‚Äî Your App is Live!</h4>
        <p>Open this URL in any browser (replace YOUR-USERNAME with your GitHub username):<br>
        <code>https://YOUR-USERNAME.github.io/census-2027/</code><br><br>
        Share this link with all VAOs and GP Secretaries. Works on phones and computers.</p>
      </div>
    </div>

    <div class="note-box">
      <strong>‚ö† How to update the app after hosting:</strong> Go to github.com ‚Üí your repository ‚Üí click <code>index.html</code> ‚Üí click pencil ‚úè ‚Üí make your change ‚Üí Commit changes. Updates go live within 2‚Äì3 minutes.
    </div>

    <div class="guide-step">
      <div class="guide-n">8</div>
      <div class="guide-body">
        <h4>Connect Google Sheets for Live Data Sync</h4>
        <p>Go to the <strong>‚òÅ Sheets Setup</strong> tab above ‚Üí follow the 4 steps ‚Üí paste the Apps Script URL ‚Üí click Save ‚Üí Test Connection.<br>
        Once connected, every time a VAO or Secretary clicks Save, the data appears in your Google Sheet within seconds.</p>
      </div>
    </div>

    <div class="info-box">
      <strong>Total Cost: ‚Çπ0 forever</strong><br>
      GitHub Pages: ‚Çπ0 ¬∑ Google Sheets: ‚Çπ0 ¬∑ Apps Script: ‚Çπ0 ¬∑ Domain (github.io): ‚Çπ0
    </div>
  </div>

  <div class="footer">
    <div class="f1">Census 2027 ‚Äî Village Population Data Entry System</div>
    <div class="f2">Designed &amp; Developed by <strong>Gangadhar</strong>, Statistical Inspector<br>Taluk Office Malavalli, Mandya</div>
    <div class="f3">¬© 2027 All rights reserved ¬∑ For official government use only</div>
  </div>
</div>

<div id="toast"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CENSUS 2027 ¬∑ MALAVALLI TALUK
//  Passwords: SHA-256 hashed ‚Äî plaintext never stored in source
//  Sync: no-cors fire-and-forget ‚Äî data always reaches sheet
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const APPS_SCRIPT_CODE = `// ‚ïê‚ïê‚ïê CENSUS 2027 ¬∑ GOOGLE APPS SCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOW TO DEPLOY (read carefully):
// 1. Open your Google Sheet
// 2. Click Extensions menu ‚Üí Apps Script
// 3. DELETE all existing code in the editor
// 4. PASTE this entire script (Ctrl+A to select all first)
// 5. Press Ctrl+S to save
// 6. Click "Deploy" button (top right) ‚Üí "New deployment"
// 7. Click the gear icon ‚öô next to "Select type"
// 8. Choose "Web app"
// 9. Set "Execute as" ‚Üí Me
// 10. Set "Who has access" ‚Üí Anyone  ‚Üê MUST BE "Anyone"
// 11. Click "Deploy"
// 12. A popup appears ‚Äî click "Authorize access"
// 13. Choose your Google account ‚Üí click "Allow"
// 14. COPY the Web App URL shown (starts with https://script.google.com/macros/s/)
// 15. Paste that URL in the Admin ‚Üí Sheets Setup tab
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const SHEET_TAB = "Census2027";

// NOTE: This script works with direct fetch() ‚Äî no JSONP needed.
// Google Apps Script automatically adds CORS headers when
// deployed with "Who has access: Anyone".

function doGet(e) {
  var result;
  try {
    var p = e.parameter || {};
    var action = p.action || "";
    if (action === "ping") {
      result = {ok: true, msg: "Census 2027 Malavalli ‚Äî Connected successfully!"};
    } else if (action === "upsert") {
      upsertRow(p);
      result = {ok: true, saved: p.rowId};
    } else {
      result = {ok: false, error: "Unknown action: " + action};
    }
  } catch(err) {
    result = {ok: false, error: err.toString()};
  }

  // Plain JSON response ‚Äî CORS headers added automatically by Google
  // when deployed with "Who has access: Anyone"
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function getOrCreateSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sh = ss.getSheetByName(SHEET_TAB);
  if (!sh) {
    sh = ss.insertSheet(SHEET_TAB);
    var headers = [
      "Row ID", "S.No", "Village Code", "Village Name", "Row Type",
      "Dakale Grama", "VAO Name", "GP Name",
      "Population (VAO)", "House Holds (VAO)", "Saved By VAO", "VAO Saved At",
      "Population (Secretary)", "House Holds (Secretary)",
      "Saved By Secretary", "Secretary Saved At"
    ];
    var hr = sh.getRange(1, 1, 1, headers.length);
    hr.setValues([headers]);
    hr.setBackground("#1a3d72")
      .setFontColor("#ffffff")
      .setFontWeight("bold")
      .setFontSize(10);
    sh.setFrozenRows(1);
    sh.setColumnWidths(1, 16, 115);
    sh.setColumnWidth(4, 160);
    sh.setColumnWidth(6, 160);
  }
  return sh;
}

function upsertRow(p) {
  var sh = getOrCreateSheet();
  var data = sh.getDataRange().getValues();
  var targetRow = -1;
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(p.rowId)) {
      targetRow = i + 1;
      break;
    }
  }
  // Preserve existing cell values ‚Äî only overwrite if new value provided
  var ex = targetRow > 0 ? data[targetRow - 1] : new Array(16).fill("");
  var row = [
    p.rowId,
    p.sno     || ex[1]  || "",
    p.code    || ex[2]  || "",
    p.village || ex[3]  || "",
    p.rowType || ex[4]  || "",
    p.dakale  || ex[5]  || "",
    p.vao     || ex[6]  || "",
    p.gp      || ex[7]  || "",
    (p.popVAO !== undefined && p.popVAO !== "") ? p.popVAO : (ex[8]  || ""),
    (p.hhVAO  !== undefined && p.hhVAO  !== "") ? p.hhVAO  : (ex[9]  || ""),
    p.byVAO   || ex[10] || "",
    p.atVAO   || ex[11] || "",
    (p.popSec !== undefined && p.popSec !== "") ? p.popSec : (ex[12] || ""),
    (p.hhSec  !== undefined && p.hhSec  !== "") ? p.hhSec  : (ex[13] || ""),
    p.bySec   || ex[14] || "",
    p.atSec   || ex[15] || ""
  ];
  if (targetRow > 0) {
    sh.getRange(targetRow, 1, 1, row.length).setValues([row]);
  } else {
    sh.appendRow(row);
    targetRow = sh.getLastRow();
  }
  // Colour coding: dakale rows = light purple, village rows = white
  sh.getRange(targetRow, 1, 1, row.length)
    .setBackground(p.rowType === "dakale" ? "#f5f0ff" : "#ffffff");
}`;

const CSV_SAMPLE = `S.No,Village Code,Village Name,Dakale Grama,VAO Name,GP Name
1,614654,Chikkamulagudu,Vaddara Kaloni,SHAFI,Chikkamulagudu
2,649474,Kurubanapura,,SHAFI,Chikkamulagudu
10,614661,Hittanahalli,"1)Hittanahalli Koppalu 2)Budukegowdanadoddi",GURURAJ,Hittanahalli`;

const DEFAULT_RAW=[
  {sno:1,code:614654,name:"Chikkamulagudu",dk:"Vaddara Kaloni",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:2,code:649474,name:"Kurubanapura",dk:"",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:3,code:614655,name:"Veerajipura",dk:"",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:4,code:614656,name:"Maganahalli",dk:"",vao:"KAVYA",gp:"Mikkere"},
  {sno:5,code:614657,name:"Mikkere",dk:"",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:6,code:614658,name:"Ramandur",dk:"Chunchagowdanakoppalu",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:7,code:614659,name:"Anasale",dk:"Ramanathamole",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:8,code:649529,name:"Halladakoppalu",dk:"",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:9,code:614660,name:"Bheemanahalli",dk:"",vao:"GURURAJ",gp:"Chikkamulagudu"},
  {sno:10,code:614661,name:"Hittanahalli",dk:"1)Hittanahalli Koppalu 2)Budukegowdanadoddi",vao:"GURURAJ",gp:"Hittanahalli"},
  {sno:11,code:614662,name:"Dugganahalli",dk:"1)Hanchipura 2)Muddegowdanadoddi",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:12,code:614663,name:"Devipura",dk:"Jayachamarajapura",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:13,code:614664,name:"Thalagavadi",dk:"",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:14,code:614665,name:"Kagepura",dk:"",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:15,code:614666,name:"Koregala",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:16,code:614667,name:"Maganur",dk:"Maganuru Kaloni",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:17,code:614668,name:"Settahalli",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:18,code:614669,name:"Muganakoppalu",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Lingapatna"},
  {sno:19,code:614670,name:"Ganiganapura",dk:"",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:20,code:614671,name:"Sasiyalapura",dk:"Gattikoppalu",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:21,code:614672,name:"Madahalli",dk:"",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:22,code:614673,name:"Hullegala",dk:"",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:23,code:614674,name:"Bandurukaval",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:24,code:614675,name:"Banduru",dk:"Dadadapura",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:25,code:614676,name:"Kallarepura",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Bandur"},
  {sno:26,code:614677,name:"Nenanuru",dk:"",vao:"PRATHIMA SM",gp:"Sujjalur"},
  {sno:27,code:614678,name:"Markalu",dk:"1)Kodenakoppalu 2)Aladahalli",vao:"PRATHIMA SM",gp:"Hittanahalli"},
  {sno:28,code:651553,name:"Jadaganapura",dk:"",vao:"PRATHIMA SM",gp:"Hittanahalli"},
  {sno:29,code:614679,name:"Doranahalli",dk:"",vao:"GURURAJ",gp:"Mikkere"},
  {sno:30,code:614680,name:"Kirugavalu",dk:"Chikkegowdanadoddi",vao:"SHAFI",gp:"Kirugavalu"},
  {sno:31,code:614681,name:"Deshavalli",dk:"",vao:"KAVYA",gp:"Bendaravadi"},
  {sno:32,code:614682,name:"Bendaravadi",dk:"",vao:"KAVYA",gp:"Bendaravadi"},
  {sno:33,code:614683,name:"Honaganahalli",dk:"",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:34,code:614684,name:"Kalkuni",dk:"1)Puttegowdanakoppalu 2)Chikkamaligekoppalu",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:35,code:651353,name:"Doddegowdanakoppalu",dk:"",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:36,code:614685,name:"Huvinakoppalu",dk:"",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:37,code:614686,name:"Sujjalur",dk:"1)Channapillekoppalu 2)Nanjegowdanadoddi",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:38,code:651447,name:"Samshettipura",dk:"",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:39,code:614687,name:"Uppanahalli",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Settihalli"},
  {sno:40,code:614688,name:"Yamadurukaval",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:41,code:614689,name:"Yamaduru",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:42,code:614690,name:"Ragibommanahalli",dk:"Hucchanadoddi",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:43,code:614691,name:"Ganaganuru",dk:"",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:44,code:614692,name:"Hangrapura",dk:"",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:45,code:614693,name:"Avverahalli",dk:"Vadakepura",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:46,code:614694,name:"Kebbepura",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:47,code:614695,name:"Maliyur",dk:"Uppagerikoppalu",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:48,code:651355,name:"Nelligere",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:49,code:614696,name:"Hanakola",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:50,code:614697,name:"Basavana Halli",dk:"",vao:"PUNEETH KUMAR N",gp:"Purigali"},
  {sno:51,code:614698,name:"Surakahalli",dk:"",vao:"PUNEETH KUMAR N",gp:"Purigali"},
  {sno:52,code:614699,name:"Nelamakanahalli",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:53,code:654905,name:"Hombegowdanadoddi",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:54,code:654906,name:"Bhugathagahalli",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:55,code:614700,name:"Appugowdana Halli",dk:"Kalakempanadoddi",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:56,code:651356,name:"Nelluru",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:57,code:614701,name:"Kaluveeranahalli",dk:"Moledoddi",vao:"USMAN BHASHA",gp:"Kandegala"},
  {sno:58,code:614702,name:"Kandegala",dk:"",vao:"USMAN BHASHA",gp:"Kandegala"},
  {sno:59,code:614703,name:"Gulagatta",dk:"",vao:"USMAN BHASHA",gp:"Nelamakanahalli"},
  {sno:60,code:614704,name:"Malavalli(Rural)",dk:"Tammadahalli",vao:"NANDEESH",gp:"Marehalli"},
  {sno:61,code:614705,name:"Nidaghatta",dk:"Kyathegowdanadoddi",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:62,code:651360,name:"Cholanahalli",dk:"",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:63,code:614706,name:"Ankanahalli",dk:"Anchedoddi",vao:"NATARAJ B",gp:"Kandegala"},
  {sno:64,code:614707,name:"Gowdagere",dk:"",vao:"SIDRAMAPPA",gp:"Nidaghatta"},
  {sno:65,code:614708,name:"Amrutheswaranahalli",dk:"",vao:"SIDRAMAPPA",gp:"Kandegala"},
  {sno:66,code:614709,name:"Kembuthagere",dk:"K. Annahalli",vao:"SIDRAMAPPA",gp:"Agasnapura"},
  {sno:67,code:614710,name:"Sahalli",dk:"",vao:"SIDRAMAPPA",gp:"Agasnapura"},
  {sno:68,code:614711,name:"Hadli",dk:"",vao:"RAVEESH M",gp:"Haadli"},
  {sno:69,code:614712,name:"Kodipura",dk:"",vao:"RAVEESH M",gp:"Agasnapura"},
  {sno:70,code:614713,name:"Koonanapura",dk:"",vao:"RAVEESH M",gp:"Haadli"},
  {sno:71,code:614714,name:"Jogipura",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Agasnapura"},
  {sno:72,code:614715,name:"Agasanapura",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Agasnapura"},
  {sno:73,code:614716,name:"Banagahalli",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:74,code:614717,name:"Chandupura",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:75,code:614718,name:"M.Shivapura",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:76,code:614719,name:"Huskur",dk:"1)Hucchegowdanadoddi 2)Appajayanadoddi 3)Kulumedoddi 4)Siddapura",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:77,code:614720,name:"Kaladevanahalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:78,code:614721,name:"Hosapura",dk:"Gollaradoddi",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:79,code:614722,name:"Aslishivapura",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:80,code:614723,name:"Belathur",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:81,code:614724,name:"Yethambadi",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:82,code:614725,name:"Antharavalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:83,code:614726,name:"Hullahalli",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Yathambadi"},
  {sno:84,code:614727,name:"Channipura",dk:"",vao:"RAVEESH M",gp:"D.Halasahalli"},
  {sno:85,code:614728,name:"Hullagala",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:86,code:614729,name:"Dadamahalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:87,code:614730,name:"Kiragasur",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:88,code:614731,name:"Banasamudra",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:89,code:614732,name:"Kaggalipura",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:90,code:614733,name:"Konnapura",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:91,code:614734,name:"Halasahalli",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:92,code:614735,name:"Dhanagur",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Dhanaguru"},
  {sno:93,code:614736,name:"Linganapura",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:94,code:614737,name:"Gramadevathepura",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Dhanaguru"},
  {sno:95,code:614738,name:"Basavanpura",dk:"",vao:"RAVEESH M",gp:"D.Halasahalli"},
  {sno:96,code:614739,name:"Nadakalapura",dk:"Nanjegowdanadoddi",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:97,code:614740,name:"Megalapura",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:98,code:614741,name:"Kamsagara",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:99,code:614742,name:"Thuraganur",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:100,code:614743,name:"Attuvanahalli",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:101,code:614744,name:"Alada Halli",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:102,code:614745,name:"Gajanur",dk:"Sunnadadoddi",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:103,code:614746,name:"Voddarahalli",dk:"1)Channegowdanadoddi 2)Annekoppalu",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:104,code:614747,name:"Marehalli",dk:"1)Bosegowdanadoddi 2)Nagegowdanadoddi",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:105,code:614748,name:"Ravani",dk:"Lakshmipuradoddi",vao:"MALLESH KP",gp:"Kyathnahalli"},
  {sno:106,code:614749,name:"Devalinganapura",dk:"",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:107,code:614750,name:"Savandipura",dk:"",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:108,code:614751,name:"Sagyasaragur",dk:"1)Honnemaradadoddi 2)Siddapura Kaloni",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:109,code:614752,name:"Nitturhalasahalli",dk:"",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:110,code:614753,name:"Kunthur",dk:"",vao:"NARASAPPA",gp:"Lingapatna"},
  {sno:111,code:614754,name:"Lingapatna",dk:"1)Naripura 2)Moogegowdanadoddi",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:112,code:614755,name:"Nittur",dk:"1)N Hosadoddi 2)Kumbegowdanadoddi",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:113,code:658634,name:"B Hosuru",dk:"",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:114,code:614756,name:"Ankanahalli",dk:"Buyyanadoddi",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:115,code:614757,name:"Maragowdanahalli",dk:"1)Kuntanadoddi 2)Heggodlu",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:116,code:614758,name:"Nitthur Kodihalli",dk:"",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:117,code:614759,name:"Karadahalli",dk:"",vao:"SIDDARAYAMALI",gp:"Lingapatna"},
  {sno:118,code:614760,name:"Vodeyarabasapura",dk:"Odubasappanadoddi",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:119,code:614761,name:"Handanahalli",dk:"",vao:"SOMANNA",gp:"Lingapatna"},
  {sno:120,code:614762,name:"Kodipura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:121,code:614763,name:"Veerajithimmanadoddi",dk:"Vaddaradoddi",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:122,code:614764,name:"Juganahalli",dk:"1)Doddegownadoddi 2)Benamanahalli",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:123,code:614765,name:"Balehonniga",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:124,code:614766,name:"Dalavaikodihalli",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:125,code:614767,name:"Deveerahalli",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:126,code:614768,name:"Kempainadoddi",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:127,code:614769,name:"Nandipura",dk:"",vao:"SOMASHEKAR P",gp:"H Basavapura"},
  {sno:128,code:614770,name:"Gundapura",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:129,code:614771,name:"Hosapetebasavapura",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:130,code:614772,name:"Hagadur",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:131,code:614773,name:"Shivanahalli",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:132,code:614774,name:"Gollarahalli",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:133,code:614775,name:"Halaguru",dk:"1)Konnapura 2)Valageredoddi",vao:"SOMANNA",gp:"Halaguru"},
  {sno:134,code:614776,name:"Halaganadoddi",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:135,code:614777,name:"Chillapura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:136,code:614778,name:"Thorekadanahalli",dk:"",vao:"BHASKAR S",gp:"Thorekadanahalli"},
  {sno:137,code:614779,name:"Nanjapura",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:138,code:614780,name:"Chikkayelachagere",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:139,code:614781,name:"Halagapura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:140,code:614782,name:"Doddayelachagere",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:141,code:614783,name:"Madahalli",dk:"",vao:"LATHA G",gp:"Dugganahalli"},
  {sno:142,code:614784,name:"Ganalu",dk:"1)Masteradoddi 2)Kenchaboyidoddi 3)Kodlayyanadoddi 4)Beeruta 5)Konnapura Doddi 6)Tagadayyanadoddi 7)Ganagalu Hosadoddi 8)Karigowdanadoddi 9)Marijogidoddi 10)Beerappanadoddi 11)Guligowdanadoddi 12)Shakunidoddi 13)Byalamaradadoddi",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:143,code:614785,name:"Bydarahalli",dk:"1)Krushnegowdanadoddi 2)Hosadoddi 3)Soligaradoddi",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:144,code:651365,name:"Karalakattedoddi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:145,code:614786,name:"Muthalakatte",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:146,code:614787,name:"Solaba",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:147,code:614788,name:"Basavanahalli",dk:"",vao:"SOMASHEKAR P",gp:"H Basavapura"},
  {sno:148,code:614789,name:"Basavana Betta Forest",dk:"",vao:"NARASAPPA",gp:"H Basavapura"},
  {sno:149,code:614790,name:"Dalanakatte",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:150,code:614791,name:"Basavegowdanadoddi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:151,code:614792,name:"Talavadi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:152,code:614793,name:"Majjigemallanahatti",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:153,code:614794,name:"Muthathi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:154,code:614795,name:"Doddaboovalli",dk:"",vao:"RUKSAR FARHEEN",gp:"Kyathnahalli"},
  {sno:155,code:614796,name:"Kyathanahalli",dk:"",vao:"RUKSAR FARHEEN",gp:"Kyathnahalli"},
  {sno:156,code:614797,name:"Kundur",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:157,code:614798,name:"Shiramalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:158,code:614799,name:"Pandithahalli",dk:"",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:159,code:614800,name:"Bachanahalli",dk:"",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:160,code:614801,name:"Manchanapura",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:161,code:614802,name:"Chottanahalli",dk:"1)Kenchanadoddi 2)Chikkanadoddi",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:162,code:651318,name:"Kunanakoppalu",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:163,code:614803,name:"Chandahalli",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:164,code:651422,name:"Varadarajaswamydoddi",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:165,code:614804,name:"Dabbahalli",dk:"",vao:"LAVANYA",gp:"Dhanaguru"},
  {sno:166,code:614805,name:"Netkal",dk:"Shimshapura",vao:"LAVANYA",gp:"Chottenahalli"},
  {sno:167,code:614806,name:"Mallikyathanahalli",dk:"Bluff(Shivanasamudra)",vao:"LANKESH H S",gp:"Hosahalli"},
  {sno:168,code:614807,name:"Belakavadi",dk:"1)Anthrayanapuradadoddi 2)Bannithalekoppalu",vao:"LANKESH H S",gp:"Belakavadi"},
  {sno:169,code:651558,name:"Javaganahalli",dk:"",vao:"LANKESH H S",gp:"Belakavadi"},
  {sno:170,code:614808,name:"Kiragasur",dk:"",vao:"LANKESH H S",gp:"Kaggalipura"},
  {sno:171,code:614809,name:"Vasuvalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kaggalipura"},
  {sno:172,code:614810,name:"Hokkarahalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kaggalipura"},
  {sno:173,code:614811,name:"Nanjanayanapura",dk:"",vao:"SHRIKANTH KOTYAL",gp:"B.G.Pura"},
  {sno:174,code:614812,name:"Dyavapatna",dk:"",vao:"SHRIKANTH KOTYAL",gp:"B.G.Pura"},
  {sno:175,code:614813,name:"Hosahalli",dk:"",vao:"PRAVEEN T K",gp:"Hosahalli"},
  {sno:176,code:614814,name:"Hebbani",dk:"",vao:"MADHU M",gp:"Pandithahalli"},
  {sno:177,code:614815,name:"Manchanahalli",dk:"",vao:"MADHU M",gp:"Pandithahalli"},
  {sno:178,code:614816,name:"Dasanadoddi",dk:"Hosadoddi",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:179,code:614817,name:"Kanchugahalli",dk:"Narayanapura",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:180,code:614818,name:"Malagalali",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:181,code:614819,name:"Thenkahalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:182,code:614820,name:"Kadabahalli",dk:"Kalyanikoppalu",vao:"MADHU M",gp:"Sarguru"},
  {sno:183,code:614821,name:"Mallinathapura",dk:"",vao:"MADHU M",gp:"Kyathnahalli"},
  {sno:184,code:614822,name:"Kaggala",dk:"",vao:"MADHU M",gp:"Kyathnahalli"},
  {sno:185,code:614823,name:"Kanikahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:186,code:614824,name:"Udape Boovalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:187,code:614825,name:"Thigadahalli",dk:"Konanakoppalu",vao:"SUBHASH",gp:"Kundur"},
  {sno:188,code:614826,name:"Boppagowdanapura",dk:"Utturu",vao:"SUDEEP KUMAR V",gp:"B.G.Pura"},
  {sno:189,code:614827,name:"Muttanahalli",dk:"",vao:"SUBHASH",gp:"B.G.Pura"},
  {sno:190,code:614828,name:"Saraguru",dk:"1)Ainorahundi 2)Halagattekoppalu 3)Agasaragoddi 4)Manchanakoppalu",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:191,code:614829,name:"Hanavadi",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:192,code:614830,name:"Purigali",dk:"Akkamallanahundi",vao:"SANJAY K",gp:"Purigali"},
  {sno:193,code:614831,name:"Hullamballi",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:194,code:614832,name:"Chikka Abbagilu",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:195,code:614833,name:"Chikkabagiluhanta",dk:"",vao:"SANJAY K",gp:"Purigali"},
  {sno:196,code:614834,name:"Maralahalli",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:197,code:614835,name:"Ballagere",dk:"",vao:"SANJAY K",gp:"Sarguru"},
  {sno:198,code:614836,name:"Somanahalli",dk:"Bilijagalimole",vao:"SANJAY K",gp:"Sarguru"},
  {sno:199,code:614837,name:"Kodagahalli",dk:"",vao:"SUBHASH",gp:"B.G.Pura"},
  {sno:200,code:614838,name:"Haladasanahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
  {sno:201,code:614839,name:"Kaggalipura",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
  {sno:202,code:651342,name:"Honaganahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
];
// ‚îÄ‚îÄ Security: hashed passwords (SHA-256 + salt 'Census2027Malavalli') ‚îÄ‚îÄ
// Actual passwords are NEVER stored as plaintext in source.
// USER_HASH  = sha256('malavalli'   + 'Census2027Malavalli')
// ADMIN_HASH = sha256('9731677328'  + 'Census2027Malavalli')
const USER_HASH  = 'c9187e936ca431f45c80d41f9f3473c63134d770002b4b6eadf4bbb592811a06';
const ADMIN_HASH = '2371a1cbe6eb14cb5d4d9cf764fcadacf64849a4724e963b03be127dcc44eff3';

async function sha256(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str+'Census2027Malavalli'));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ Sheet URL baked at deploy time (Admin: Download Updated App) ‚îÄ‚îÄ
// Replace __SHEET_URL__ with your actual URL and re-host the file.
// Users on new devices will get sync automatically without any setup.
const BAKED_URL = 'https://script.google.com/macros/s/AKfycbyOfHddzGH3Ob9p0IDLgUcur3W2JHn-IMXbao8-mTYPEC6jHV5_YKBD2MSq7JSOQ8rI/exec';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  role:null, loginRole:'vao', uname:'', vis:[], allRows:[],
  raw: JSON.parse(localStorage.getItem('c27_raw')||'null') || DEFAULT_RAW,
  entries:  JSON.parse(localStorage.getItem('c27_e') ||'{}'),
  syncSt:   JSON.parse(localStorage.getItem('c27_ss')||'{}'),
  sheetUrl: (BAKED_URL && BAKED_URL !== '' ? BAKED_URL : '') || localStorage.getItem('c27_url') || '',
  failedQ:[], toastTmr:null, pendingUpload:null
};
function persist(){
  localStorage.setItem('c27_e',  JSON.stringify(S.entries));
  localStorage.setItem('c27_ss', JSON.stringify(S.syncSt));
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $=id=>document.getElementById(id);
const show=id=>$(id).classList.remove('hidden');
const hide=id=>$(id).classList.add('hidden');
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function toast(msg,type){
  const t=$('toast'); t.textContent=msg; t.className='show t'+(type||'ok');
  if(S.toastTmr) clearTimeout(S.toastTmr);
  S.toastTmr = setTimeout(()=>t.className='', 3500);
}

// ‚îÄ‚îÄ Build flat row list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDk(s){
  if(!s||!s.trim()) return [];
  const m = s.match(/\d+\)\s*([^0-9)]+)/g);
  if(m&&m.length>1) return m.map(x=>x.replace(/^\d+\)\s*/,'').trim()).filter(Boolean);
  return [s.trim()];
}
function buildRows(raw){
  const rows=[];
  raw.forEach(v=>{
    const dks=parseDk(v.dk||'');
    rows.push({...v, type:'village', rid:'V_'+v.code, dkNames:dks});
    dks.forEach((d,i)=>rows.push({...v, type:'dakale', rid:'D_'+v.code+'_'+i, dkName:d}));
  });
  return rows;
}
const getVAOs=raw=>[...new Set(raw.map(v=>v.vao))].filter(Boolean).sort();
const getGPs =raw=>[...new Set(raw.map(v=>(v.gp||'').trim()))].filter(Boolean).sort();

// ‚îÄ‚îÄ Login / Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTab(role){
  S.loginRole=role;
  ['vao','sec','adm'].forEach(r=>$('tab-'+r).className='rtab');
  $('tab-'+{vao:'vao',secretary:'sec',admin:'adm'}[role]).className='rtab on';
  const isAdmin = role==='admin';
  $('name-grp').classList[isAdmin?'add':'remove']('hidden');
  if(!isAdmin){
    $('name-lbl').textContent = role==='vao'?'VAO Name':'Panchayath Name';
    const sel=$('name-sel');
    sel.innerHTML='<option value="">-- Select --</option>';
    (role==='vao'?getVAOs(S.raw):getGPs(S.raw)).forEach(x=>{
      const o=document.createElement('option'); o.value=x; o.textContent=x; sel.appendChild(o);
    });
  }
  hide('login-err');
}

async function doLogin(){
  const nm=$('name-sel').value, pw=$('pwd').value;
  if(!pw){showErr('‡≤ó‡≥Å‡≤™‡≥ç‡≤§‡≤™‡≤¶ ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø / Enter password.');return;}
  const hash = await sha256(pw);
  // ADMIN
  if(S.loginRole==='admin'){
    if(hash!==ADMIN_HASH){showErr('Incorrect admin password.');return;}
    S.role='admin'; S.uname='Administrator';
    setHdr('‚öô Admin','chip-adm','Administrator');
    $('pwd').value=''; hide('login-err');
    hide('pg-login'); show('pg-admin');
    buildAdmin(); return;
  }
  // VAO / SECRETARY
  if(!nm){showErr('‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤π‡≥Ü‡≤∏‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü ‡≤Æ‡≤æ‡≤°‡≤ø / Select your name.');return;}
  if(hash!==USER_HASH){showErr('‡≤§‡≤™‡≥ç‡≤™‡≤æ‡≤¶ ‡≤ó‡≥Å‡≤™‡≥ç‡≤§‡≤™‡≤¶ / Incorrect password.');return;}
  fetchFromSheet(nm);
  S.role=S.loginRole; S.uname=nm;
  S.allRows=buildRows(S.raw);
  S.vis = S.role==='vao'
    ? S.allRows.filter(r=>r.vao===nm)
    : S.allRows.filter(r=>(r.gp||'').trim()===nm);
  setHdr(S.role==='vao'?'üë§ VAO':'üè¢ Secretary',
         S.role==='vao'?'chip-vao':'chip-sec', nm);
  $('sb-title').textContent = S.role==='vao'?'üë§ VAO Panel':'üè¢ Secretary Panel';
  $('sb-nm').textContent    = nm;
  $('sb-role').textContent  = S.role==='vao'?'Village Accountant':'Grama Panchayath';
  $('th3').textContent = '‡≤ó‡≥ç‡≤∞‡≤æ.‡≤™‡≤Ç ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å';
  $('th4').textContent = S.role==='vao'?'‡≤á‡≤Ç‡≤¶‡≤ø‡≤® ‡≤ú‡≤®‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü (‡≤ó‡≥ç‡≤∞‡≤æ.‡≤≤‡≥Ü)':'‡≤á‡≤Ç‡≤¶‡≤ø‡≤® ‡≤ú‡≤®‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü (‡≤ï‡≤æ‡≤∞‡≥ç‡≤Ø.‡≤¶.)';
  $('th5').textContent = S.role==='vao'?'‡≤Æ‡≤®‡≥Ü‡≤ó‡≤≥/‡≤ï‡≥Å‡≤ü‡≥Å‡≤Ç‡≤¨‡≤ó‡≤≥ ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü(‡≤ó‡≥ç‡≤∞‡≤æ.‡≤≤‡≥Ü)':'‡≤Æ‡≤®‡≥Ü‡≤ó‡≤≥/‡≤ï‡≥Å‡≤ü‡≥Å‡≤Ç‡≤¨‡≤ó‡≤≥ ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü(‡≤ï‡≤æ‡≤∞‡≥ç‡≤Ø.‡≤¶.)';
  const vc=S.vis.filter(r=>r.type==='village').length;
  $('ct-title').textContent = nm+' ‚Äî Data Entry';
  $('ct-sub').textContent   = vc+' villages ¬∑ Dakale Gramas shown as ‚Ü≥ sub-rows ¬∑ Auto-saves locally, syncs to Google Sheets';
  S.failedQ = Object.keys(S.syncSt).filter(k=>S.syncSt[k]==='err');
  $('pwd').value=''; hide('login-err');
  // Mobile topbar
  const mt=$('mob-topbar'), ms2=$('mob-stats');
  if(mt){mt.style.display='flex'; $('mob-name').textContent=nm; $('mob-role').textContent=S.role==='vao'?'Village Accountant Officer':'Grama Panchayath Secretary';}
  if(ms2) ms2.style.display='grid';
  // ‚îÄ‚îÄ Auto-refresh sheetUrl from BAKED_URL or localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  S.sheetUrl = (BAKED_URL && BAKED_URL !== 'https://script.google.com/macros/s/AKfycbwrvD16_t1qz037rEtEnlOGg12EzvUdsNYCL0WHPfwNG7QnZoM-nQexOuQH6xXVCqQ4/exec' ? BAKED_URL : '') || localStorage.getItem('c27_url') || '';
  updateSyncUI(); renderTable(); updateStats();
  hide('pg-login'); show('pg-entry');
  // Show URL setup banner if no sheet configured on this device
  const banner=$('url-setup-banner');
  if(banner){   S.sheetUrl = (BAKED_URL && BAKED_URL !== 'https://script.google.com/macros/s/AKfycbwn3HTMQSaId_LucXRxLt4dCb8bfsfiqsWmFdeg_s1R-kQnM4skB5G8FD3zCtUG-omH/exec' ? BAKED_URL : '') || localStorage.getItem('c27_url') || '';   banner.classList.toggle('hidden', !!S.sheetUrl); }
}

function showErr(msg){$('login-err').textContent=msg;show('login-err');}

function setHdr(chip,cls,nm){
  const c=$('hdr-chip'); c.textContent=chip; c.className='hdr-chip '+cls;
  $('hdr-nm').textContent=nm;
  $('hdr-sess').style.display='flex';
}

// ‚îÄ‚îÄ Show/Hide password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePwd(){
  const inp=$('pwd'), btn=$('eye-btn');
  if(inp.type==='password'){inp.type='text'; btn.textContent='üôà';}
  else{inp.type='password'; btn.textContent='üëÅ';}
  inp.focus();
}

// ‚îÄ‚îÄ Save URL from the entry-page banner (VAO/Sec on new device) ‚îÄ‚îÄ
function saveBannerUrl(){
  const v=($('banner-url-inp').value||'').trim();
  if(!v||!v.includes('script.google.com/macros')){
    toast('Please enter a valid Apps Script URL','bad'); return;
  }
  S.sheetUrl=v; localStorage.setItem('c27_url',v);
  const banner=$('url-setup-banner');
  if(banner) banner.classList.add('hidden');
  toast('‚úÖ Sheet URL saved ‚Äî sync is now active!');
  updateSyncUI();
}

function doLogout(){
  S.role=null; S.uname=''; S.vis=[];
  $('hdr-sess').style.display='none';
  const mt=$('mob-topbar'), ms=$('mob-stats');
  if(mt) mt.style.display='none';
  if(ms) ms.style.display='none';
  ['pg-entry','pg-admin'].forEach(hide); show('pg-login');
  $('name-sel').value=''; $('pwd').value='';
}

// ‚îÄ‚îÄ Sync UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSyncUI(){
  // Re-read from localStorage on every call (fixes mobile "not connected" bug)
 S.sheetUrl = (BAKED_URL && BAKED_URL !== 'https://script.google.com/macros/s/AKfycbwrvD16_t1qz037rEtEnlOGg12EzvUdsNYCL0WHPfwNG7QnZoM-nQexOuQH6xXVCqQ4/exec' ? BAKED_URL : '') || localStorage.getItem('c27_url') || '';
  const b=$('ss-blk'), t=$('ss-txt');
  hide('pill-no'); hide('pill-ok'); hide('pill-warn');
  let dotCls, txt, blkCls, mobTxt='';
  if(!S.sheetUrl){
    dotCls='bdot bd-a'; txt='Not connected to Sheets'; blkCls='sync-stat ss-no'; show('pill-no'); mobTxt='üî¥ No Sync';
  } else if(S.failedQ.length>0){
    dotCls='bdot bd-r'; txt=S.failedQ.length+' rows failed'; blkCls='sync-stat ss-err'; show('pill-warn');
    $('btn-retry').classList.remove('hidden'); mobTxt='üî¥ Retry';
  } else {
    dotCls='bdot bd-g'; txt='Connected ‚Äî auto-syncing ‚úì'; blkCls='sync-stat ss-ok'; show('pill-ok');
    $('btn-retry').classList.add('hidden'); mobTxt='üü¢ Syncing';
  }
  b.className=blkCls;
  b.innerHTML='<span class="'+dotCls+'"></span><span id="ss-txt">'+txt+'</span>';
  const ms=$('mob-sync'); if(ms) ms.textContent=mobTxt;
}

// ‚îÄ‚îÄ Progress stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats(){
  if(!S.vis.length) return;
  const total=S.vis.length, vc=S.vis.filter(r=>r.type==='village').length;
  const done=S.vis.filter(r=>{
    const e=S.entries[r.rid]||{};
    return S.role==='vao'?(e.pV!==undefined&&e.pV!==''):(e.pS!==undefined&&e.pS!=='');
  }).length;
  const synced=S.vis.filter(r=>S.syncSt[r.rid]==='ok').length;
  const pct=Math.round(done/Math.max(total,1)*100);
  $('sb-v').textContent=vc;
  $('sb-t').textContent=total;
  $('sb-done').textContent=done+'/'+total;
  $('sb-done').className='sval '+(done===total?'g':'a');
  $('sb-sync').textContent=S.sheetUrl?synced+'/'+total:'N/A';
  $('sb-sync').className='sval '+(synced===done&&S.sheetUrl?'g':'a');
  $('pb-pct').textContent=pct+'%';
  $('pfill').style.width=pct+'%';
  // Mobile mini-stats
  const mv=$('mob-v'),md=$('mob-done'),mp=$('mob-pct');
  if(mv) mv.textContent=vc;
  if(md) md.textContent=done;
  if(mp) mp.textContent=pct+'%';
}

// ‚îÄ‚îÄ Render table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable(){
  let h='';
  S.vis.forEach(r=>{
    const e=S.entries[r.rid]||{}, isDk=r.type==='dakale', isV=S.role==='vao';
    const pv=isV?(e.pV||''):(e.pS||''), hv=isV?(e.hV||''):(e.hS||'');
    const saved=pv!=='', syn=S.syncSt[r.rid]||'';
    const rid=esc(r.rid);
    const cls=(isDk?'drow':'vrow')+(saved?' done':'');
    const snoTd=isDk?'<td><span class="dk-arr">‚Ü≥</span></td>':'<td><span class="sno-c">'+r.sno+'</span></td>';
    const nmTd=isDk
      ?'<td><div class="dk-rl"><div class="dk-dl"></div><span class="dk-nm">'+esc(r.dkName)+'</span><span class="dk-ch">DAKALE</span></div></td>'
      :'<td><div class="vname">'+esc(r.name)+'</div>'+(r.dkNames&&r.dkNames.length?'<div class="dk-hint">'+r.dkNames.length+' dakale ‚Üì</div>':'')+'</td>';
    // Secretary sees GP name (same as VAO), not VAO name
    const gpTd='<td><span class="gp-ch">'+esc((r.gp||'').trim())+'</span></td>';
    const dotH=syn?'<span class="rdot v '+(syn==='ok'?'rd-ok':'rd-err')+'" id="rd-'+rid+'"></span>'
                   :'<span class="rdot" id="rd-'+rid+'"></span>';
    const actH=saved
      ?dotH+'<button class="btn-ed" onclick="editRow(\''+rid+'\')">‚úé Edit</button>'
      :dotH+'<button class="btn-sv" onclick="saveRow(\''+rid+'\')">Save</button>';
    h+='<tr class="'+cls+'" id="tr-'+rid+'">'
      +snoTd+'<td><span class="cm">'+r.code+'</span></td>'
      +nmTd+gpTd
      +'<td><input class="ni'+(pv?' ok':'')+'" type="text" inputmode="numeric" id="p-'+rid
        +'" value="'+esc(pv)+'" placeholder="Enter" oninput="oninp(\''+rid+'\',this)"/></td>'
      +'<td><input class="ni'+(hv?' ok':'')+'" type="text" inputmode="numeric" id="h-'+rid
        +'" value="'+esc(hv)+'" placeholder="Enter" oninput="oninp(\''+rid+'\',this)"/></td>'
      +'<td><div class="act" id="ac-'+rid+'">'+actH+'</div></td></tr>\n';
  });
  $('tbody').innerHTML=h;
}

function oninp(rid,el){
  el.value=el.value.replace(/[^0-9]/g,'');
  const ac=$('ac-'+rid);
  if(ac&&!ac.querySelector('.btn-sv'))
    ac.innerHTML='<span class="rdot" id="rd-'+rid+'"></span><button class="btn-sv" onclick="saveRow(\''+esc(rid)+'\')">Save</button>';
}

function editRow(rid){
  ['p-','h-'].forEach(p=>{const el=$(p+rid);if(el){el.classList.remove('ok');el.focus();}});
  $('ac-'+rid).innerHTML='<span class="rdot" id="rd-'+rid+'"></span><button class="btn-sv" onclick="saveRow(\''+esc(rid)+'\')">Save</button>';
}

function saveRow(rid){
  const pEl=$('p-'+rid), hEl=$('h-'+rid);
  const pv=pEl?pEl.value.replace(/[^0-9]/g,''):'';
  const hv=hEl?hEl.value.replace(/[^0-9]/g,''):'';
  if(pv===''&&hv===''){toast('‚ö† Enter Population or House Holds first','bad');return;}
  const e=S.entries[rid]||{}, up={...e}, now=new Date().toLocaleString('en-IN');
  if(S.role==='vao'){if(pv)up.pV=pv;if(hv)up.hV=hv;up.byV=S.uname;up.atV=now;}
  else{if(pv)up.pS=pv;if(hv)up.hS=hv;up.byS=S.uname;up.atS=now;}
  S.entries[rid]=up; persist();
  const row=S.allRows.find(r=>r.rid===rid);
  toast('‚úì Saved: '+(row?(row.type==='dakale'?row.dkName:row.name):rid));
  const tr=$('tr-'+rid);
  if(tr) tr.className=(row&&row.type==='dakale'?'drow':'vrow')+' done';
  if(pEl)pEl.classList.add('ok'); if(hEl)hEl.classList.add('ok');
  $('ac-'+rid).innerHTML='<span class="rdot" id="rd-'+rid+'"></span><button class="btn-ed" onclick="editRow(\''+esc(rid)+'\')">‚úé Edit</button>';
  updateStats();
  if(row) syncRow(rid,row,up);
}
  async function fetchFromSheet(user){
  if(!S.sheetUrl) return;

  try{
    const res = await fetch(S.sheetUrl + '?action=getUserData&user=' + encodeURIComponent(user));
    const json = await res.json();

    if(json.success){
      json.rows.forEach(r=>{
        const rid = r["Row ID"];
        if(!rid) return;

        if(!S.entries[rid]) S.entries[rid] = {};

        S.entries[rid].pV = r["Population (VAO)"] || '';
        S.entries[rid].hV = r["House Holds (VAO)"] || '';
        S.entries[rid].pS = r["Population (Secretary)"] || '';
        S.entries[rid].hS = r["House Holds (Secretary)"] || '';

        S.syncSt[rid] = 'ok';
      });

      persist();
      renderTable();
      updateStats();
      updateSyncUI();
    }

  }catch(err){
    console.warn("Sheet fetch failed", err);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TWO-WAY GOOGLE SHEETS SYNC (FINAL VERSION)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Pull data from Sheet on login (multi-device consistency)
async function fetchFromSheet(user){
  const url = S.sheetUrl;
  if(!url) return;

  try{
    const res = await fetch(url + '?action=getUserData&user=' + encodeURIComponent(user));
    const json = await res.json();
    if(!json.success) return;

    json.rows.forEach(r=>{
      const rid = r["Row ID"];
      if(!rid) return;

      const entry = S.entries[rid] || {};

      // VAO data
      if(r["Population (VAO)"] !== "" && r["Population (VAO)"] != null)
        entry.pV = r["Population (VAO)"];
      if(r["House Holds (VAO)"] !== "" && r["House Holds (VAO)"] != null)
        entry.hV = r["House Holds (VAO)"];

      // Secretary data
      if(r["Population (Secretary)"] !== "" && r["Population (Secretary)"] != null)
        entry.pS = r["Population (Secretary)"];
      if(r["House Holds (Secretary)"] !== "" && r["House Holds (Secretary)"] != null)
        entry.hS = r["House Holds (Secretary)"];

      S.entries[rid] = entry;
      S.syncSt[rid] = 'ok';
    });

    persist();
    renderTable();
    updateStats();
    updateSyncUI();

  }catch(e){
    console.warn("Sheet fetch failed", e);
  }
}

// Push single row to Sheet (compatible with your structure)
async function syncRow(rid,row,entry){
  if(!S.sheetUrl) return;

  const params = new URLSearchParams({
    action: 'upsert',
    rowId: rid,
    sno: row.sno,
    code: row.code,
    village: row.name,
    rowType: row.type,
    dakale: row.dkName || '',
    vao: row.vao,
    gp: row.gp,
    popVAO: entry.pV || '',
    hhVAO: entry.hV || '',
    byVAO: entry.byV || '',
    atVAO: entry.atV || '',
    popSec: entry.pS || '',
    hhSec: entry.hS || '',
    bySec: entry.byS || '',
    atSec: entry.atS || ''
  });

  const dot = $('rd-'+rid);
  if(dot) dot.className='rdot v rd-spin';

  try{
    await fetch(S.sheetUrl + '?' + params.toString(), {mode:'no-cors'});
    S.syncSt[rid]='ok';
    persist();
    if(dot) dot.className='rdot v rd-ok';
  }catch(e){
    S.syncSt[rid]='err';
    S.failedQ.push(rid);
    persist();
    if(dot) dot.className='rdot v rd-err';
  }

  updateSyncUI();
}

// Retry failed rows
function retryFailed(){
  if(!S.sheetUrl) return;
  const failed = [...S.failedQ];
  S.failedQ=[];
  failed.forEach(rid=>{
    const row = S.allRows.find(r=>r.rid===rid);
    if(row) syncRow(rid,row,S.entries[rid]);
  });
}

// ‚îÄ‚îÄ Admin dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAdminTab(n){
  for(let i=0;i<4;i++){$('at-'+i).className='atab';$('ap-'+i).className='apanel hidden';}
  $('at-'+n).className='atab on'; $('ap-'+n).className='apanel';
}

function buildAdmin(){
  const allRows=buildRows(S.raw);
  const villages=allRows.filter(r=>r.type==='village');
  const total=villages.length;
  const vDone=villages.filter(r=>(S.entries[r.rid]||{}).pV!==undefined&&(S.entries[r.rid]||{}).pV!=='').length;
  const sDone=villages.filter(r=>(S.entries[r.rid]||{}).pS!==undefined&&(S.entries[r.rid]||{}).pS!=='').length;
  const synced=allRows.filter(r=>S.syncSt[r.rid]==='ok').length;
  const vPct=Math.round(vDone/Math.max(total,1)*100);
  const sPct=Math.round(sDone/Math.max(total,1)*100);

  // Stat cards
  $('admin-cards').innerHTML=`
    <div class="stat-card"><div class="sc-ico">üèò</div><div class="sc-val">${total}</div><div class="sc-lbl">Total Villages</div><div class="sc-bar"><div class="sc-fill" style="width:100%"></div></div></div>
    <div class="stat-card"><div class="sc-ico">üë§</div><div class="sc-val">${vDone}</div><div class="sc-lbl">VAO Completed (${vPct}%)</div><div class="sc-bar"><div class="sc-fill" style="width:${vPct}%"></div></div></div>
    <div class="stat-card"><div class="sc-ico">üè¢</div><div class="sc-val">${sDone}</div><div class="sc-lbl">Secretary Verified (${sPct}%)</div><div class="sc-bar"><div class="sc-fill" style="width:${sPct}%"></div></div></div>
    <div class="stat-card"><div class="sc-ico">‚òÅ</div><div class="sc-val">${synced}</div><div class="sc-lbl">Rows Synced to Sheet</div><div class="sc-bar"><div class="sc-fill" style="width:${Math.round(synced/Math.max(allRows.length,1)*100)}%"></div></div></div>
    <div class="stat-card"><div class="sc-ico">${S.sheetUrl?'üü¢':'üî¥'}</div><div class="sc-val">${S.sheetUrl?'ON':'OFF'}</div><div class="sc-lbl">Google Sheets Connection</div></div>
  `;

  // VAO-wise table
  const vaos=getVAOs(S.raw);
  let vaoHtml='';
  vaos.forEach((vao,i)=>{
    const vRows=allRows.filter(r=>r.vao===vao&&r.type==='village');
    const cnt=vRows.length;
    const vC=vRows.filter(r=>{const e=S.entries[r.rid]||{};return e.pV!==undefined&&e.pV!=='';}).length;
    const sC=vRows.filter(r=>{const e=S.entries[r.rid]||{};return e.pS!==undefined&&e.pS!=='';}).length;
    const pct=Math.round(vC/Math.max(cnt,1)*100);
    const badgeCls=vC===cnt?'b-done':vC>0?'b-part':'b-none';
    const badgeTxt=vC===cnt?'Complete':vC>0?'In Progress':'Not Started';
    vaoHtml+=`<tr>
      <td>${i+1}</td><td><strong>${esc(vao)}</strong></td><td>${cnt}</td>
      <td>${vC}/${cnt}</td><td>${sC}/${cnt}</td>
      <td><div class="mini-bar"><div class="mini-fill" style="width:${pct}%"></div></div><span style="font-size:11px;color:#475569;margin-left:6px">${pct}%</span></td>
      <td><span class="badge ${badgeCls}">${badgeTxt}</span></td>
    </tr>`;
  });
  $('vao-tbody').innerHTML=vaoHtml;

  // Village detail table
  let vilHtml='';
  villages.forEach((r,i)=>{
    const e=S.entries[r.rid]||{}, syn=S.syncSt[r.rid]||'';
    const dot=syn==='ok'?'üü¢':syn==='err'?'üî¥':'‚ö™';
    vilHtml+=`<tr>
      <td>${i+1}</td>
      <td><span class="cm">${r.code}</span></td>
      <td><strong>${esc(r.name)}</strong>${r.dkNames&&r.dkNames.length?'<br><span style="font-size:10px;color:#a78bfa">+'+r.dkNames.length+' dakale</span>':''}</td>
      <td style="font-size:12px">${esc(r.vao||'')}</td>
      <td><span class="gp-ch">${esc((r.gp||'').trim())}</span></td>
      <td style="text-align:right">${e.pV||'‚Äî'}</td>
      <td style="text-align:right">${e.hV||'‚Äî'}</td>
      <td style="text-align:right">${e.pS||'‚Äî'}</td>
      <td style="text-align:right">${e.hS||'‚Äî'}</td>
      <td style="text-align:center">${dot}</td>
    </tr>`;
  });
  $('vil-tbody').innerHTML=vilHtml;
}

// ‚îÄ‚îÄ Sheets Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('script-box').textContent = APPS_SCRIPT_CODE;
$('csv-sample').textContent = CSV_SAMPLE;

function copyScript(){
  const btn=$('cp-btn');
  const done=()=>{btn.textContent='Copied ‚úì';btn.className='cp-btn done';setTimeout(()=>{btn.textContent='Copy';btn.className='cp-btn';},2500);};
  if(navigator.clipboard){navigator.clipboard.writeText(APPS_SCRIPT_CODE).then(done).catch(done);}
  else{const ta=document.createElement('textarea');ta.value=APPS_SCRIPT_CODE;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);done();}
}

function onUrlInput(){
  const v=($('url-inp').value||'').trim();
  const btn=$('open-tab-btn'), hint=$('tab-hint');
  if(v && v.includes('script.google.com/macros')){
    btn.disabled=false; btn.style.opacity='1'; btn.style.cursor='pointer';
    hint.textContent='Click button above to open in new tab';
  } else if(v && !v.includes('script.google.com/macros')){
    btn.disabled=true; btn.style.opacity='.4'; btn.style.cursor='not-allowed';
    hint.textContent='URL must contain script.google.com/macros';
  } else {
    btn.disabled=true; btn.style.opacity='.4'; btn.style.cursor='not-allowed';
    hint.textContent='Paste URL above first';
  }
}

function openInTab(){
  const url=($('url-inp').value||'').trim();
  if(!url){toast('Paste URL first','bad');return;}
  window.open(url+'?action=ping','_blank');
}

function markConnected(){
  const url=($('url-inp').value||'').trim()||S.sheetUrl;
  if(!url||!url.includes('script.google.com/macros')){
    toast('Paste your Web App URL in the field above first','bad');return;
  }
  S.sheetUrl=url; localStorage.setItem('c27_url',url);
  $('url-inp').value=url;
  $('url-inp').className='url-inp ok';
  $('url-saved-msg').classList.remove('hidden');
  toast('‚úÖ URL saved! Now click "Download Updated App" in Hosting Guide to bake URL into the file for all users','info');
  updateSyncUI();
  buildAdmin();
}

function saveUrl(){
  const v=($('url-inp').value||'').trim();
  if(!v||!v.startsWith('https://')){toast('Enter a valid URL starting with https://','bad');return;}
  if(!v.includes('script.google.com/macros')){
    toast('URL must contain script.google.com/macros ‚Äî check you copied the Web App URL','bad');return;
  }
  S.sheetUrl=v; localStorage.setItem('c27_url',v);
  $('url-inp').className='url-inp ok';
  $('url-saved-msg').classList.remove('hidden');
  toast('‚úì URL saved ‚Äî open it in a new tab to verify it shows {"ok":true}');

}

// ‚îÄ‚îÄ Upload CSV/Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleDrop(e){
  e.preventDefault();
  $('drop-zone').classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f) processFile(f);
}
function handleFile(inp){
  const f=inp.files[0]; if(!f) return;
  processFile(f); inp.value='';
}

function processFile(file){
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'){
    const reader=new FileReader();
    reader.onload=e=>parseCSV(e.target.result);
    reader.readAsText(file);
  } else if(ext==='xlsx'||ext==='xls'){
    toast('For Excel files: File ‚Üí Save As ‚Üí CSV, then upload the CSV','info');
  } else {
    toast('Please upload a .csv file','bad');
  }
}

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  if(lines.length<2){toast('CSV appears empty','bad');return;}
  const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[^a-z0-9]/g,''));
  const colMap={
    sno:       headers.findIndex(h=>h.includes('sno')||h.includes('serial')),
    code:      headers.findIndex(h=>h.includes('code')),
    name:      headers.findIndex(h=>h.includes('name')&&!h.includes('vao')&&!h.includes('gp')),
    dk:        headers.findIndex(h=>h.includes('dakale')||h.includes('dk')),
    vao:       headers.findIndex(h=>h.includes('vao')),
    gp:        headers.findIndex(h=>h.includes('gp')||h.includes('panchayat')),
  };
  if(colMap.name<0||colMap.vao<0||colMap.gp<0){
    toast('Missing required columns: Village Name, VAO Name, GP Name','bad');return;
  }
  // Parse CSV rows (handle quoted fields)
  function parseRow(line){
    const cols=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){inQ=!inQ;}
      else if(c===','&&!inQ){cols.push(cur.trim());cur='';}
      else cur+=c;
    }
    cols.push(cur.trim()); return cols;
  }
  const data=[];
  for(let i=1;i<Math.min(lines.length,1001);i++){
    if(!lines[i].trim()) continue;
    const cols=parseRow(lines[i]);
    const row={
      sno:  colMap.sno>=0?parseInt(cols[colMap.sno])||i:i,
      code: colMap.code>=0?parseInt(cols[colMap.code])||Date.now()+i:Date.now()+i,
      name: (cols[colMap.name]||'').trim(),
      dk:   colMap.dk>=0?(cols[colMap.dk]||'').trim():'',
      vao:  (cols[colMap.vao]||'').trim().toUpperCase(),
      gp:   (cols[colMap.gp]||'').trim(),
    };
    if(row.name) data.push(row);
  }
  if(!data.length){toast('No valid village rows found in CSV','bad');return;}
  S.pendingUpload=data;
  showPreview(data, lines[0].split(','));
}

function showPreview(data,headers){
  const sample=data.slice(0,5);
  let h='<thead><tr>'+headers.map(h=>'<th>'+esc(h.trim())+'</th>').join('')+'</tr></thead><tbody>';
  sample.forEach(r=>{
    h+=`<tr><td>${r.sno}</td><td>${r.code}</td><td>${esc(r.name)}</td><td>${esc(r.dk)}</td><td>${esc(r.vao)}</td><td>${esc(r.gp)}</td></tr>`;
  });
  h+='</tbody>';
  $('prev-tbl').innerHTML=h;
  show('upload-preview');
  toast(data.length+' village rows found ‚Äî preview shown below','info');
}

function applyUpload(){
  if(!S.pendingUpload){toast('No data to apply','bad');return;}
  S.raw=S.pendingUpload; S.pendingUpload=null;
  localStorage.setItem('c27_raw',JSON.stringify(S.raw));
  hide('upload-preview');
  toast('‚úì '+S.raw.length+' villages loaded ‚Äî VAO/Secretary logins will use this data');
  buildAdmin();
}

function cancelUpload(){
  S.pendingUpload=null; hide('upload-preview');
  toast('Upload cancelled','info');
}

function resetToDefault(){
  if(!confirm('Reset to built-in 202 villages? Entered population data is NOT affected.')) return;
  S.raw=DEFAULT_RAW;
  localStorage.removeItem('c27_raw');
  toast('‚úì Reset to default 202 villages');
  buildAdmin();
}

// ‚îÄ‚îÄ Download self ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadSelf(){
  let html = document.documentElement.outerHTML;

  if(S.sheetUrl){
    html = html.replace(
      /const BAKED_URL = '.*?';/,
      "const BAKED_URL = '" + S.sheetUrl.replace(/'/g,"\\'") + "';"
    );
    toast('‚úÖ Downloading with Google Sheets URL baked in ‚Äî re-host this file for all users');
  } else {
    toast('‚¨á Downloading app (no sheet URL configured)','info');
  }

  const blob = new Blob([html],{type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'census2027.html';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setTab('vao');
// Resolve sheetUrl on every page load from BAKED_URL or localStorage
S.sheetUrl = (BAKED_URL && BAKED_URL !== 'https://script.google.com/macros/s/AKfycbwn3HTMQSaId_LucXRxLt4dCb8bfsfiqsWmFdeg_s1R-kQnM4skB5G8FD3zCtUG-omH/exec' ? BAKED_URL : '') || localStorage.getItem('c27_url') || '';
if(S.sheetUrl){
  if($('url-inp')){
    $('url-inp').value=S.sheetUrl;
    $('url-inp').className='url-inp ok';
  }
  if($('url-saved-msg')) $('url-saved-msg').classList.remove('hidden');
}
</script>
</body>
</html>
