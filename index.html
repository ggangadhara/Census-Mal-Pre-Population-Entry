<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>‡≤ú‡≤®‡≤ó‡≤£‡≤§‡≤ø 2027 ¬∑ ‡≤Æ‡≤≥‡≤µ‡≤≥‡≥ç‡≤≥‡≤ø</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada:wght@400;600;700&family=Mukta:wght@400;600;700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1a3d72;--dark:#0d2448;--gold:#c9a227;--green:#16a34a;--red:#dc2626;--amber:#d97706;--bg:#eef2f8;--card:#fff;--bdr:#e2e8f0;--txt:#1e293b;--mut:#64748b}
html,body{min-height:100vh;background:var(--bg);font-family:'Mukta','Noto Sans Kannada',Arial,sans-serif;color:var(--txt);font-size:14px}
.kn{font-family:'Noto Sans Kannada',sans-serif}
.hi{display:none!important}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px}

/* OVERLAY */
#ov{position:fixed;inset:0;background:rgba(13,36,72,.72);z-index:600;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#ov .sp{width:52px;height:52px;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite}
#ov p{color:#fff;font-size:15px;font-weight:700;font-family:'Noto Sans Kannada',sans-serif;text-align:center}
@keyframes sp{to{transform:rotate(360deg)}}

/* HEADER */
.hdr{background:linear-gradient(95deg,var(--blue),var(--dark));border-bottom:3px solid var(--gold);position:sticky;top:0;z-index:200;box-shadow:0 2px 14px rgba(0,0,0,.3)}
.hdr-in{max-width:1280px;margin:0 auto;padding:9px 18px;display:flex;align-items:center;gap:12px}
.seal{width:42px;height:42px;border-radius:50%;background:conic-gradient(#e2b93b,#c9a227,#a07818,#c9a227,#e2b93b);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.hdr-t{flex:1;min-width:0}
.hdr-t h1{font-family:'Noto Serif',serif;color:#fff;font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hdr-t p{color:#90b8e8;font-size:11px;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:8px;flex-shrink:0}
.chip{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid}
.cv{background:rgba(59,130,246,.2);border-color:#60a5fa;color:#93c5fd}
.cs{background:rgba(16,185,129,.2);border-color:#34d399;color:#6ee7b7}
.ca{background:rgba(245,158,11,.2);border-color:#fbbf24;color:#fde68a}
.hnm{color:#90b8e8;font-size:11px;font-weight:600;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.blo{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;padding:5px 13px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.blo:hover{background:rgba(255,255,255,.22)}
#hdr-s{display:none;align-items:center;gap:8px}

/* PAGE */
.pg{max-width:1280px;margin:0 auto;padding:20px 16px}

/* LOGIN */
.lw{max-width:420px;margin:28px auto}
.lcard{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(13,36,72,.2);overflow:hidden}
.ltop{background:linear-gradient(135deg,var(--blue),var(--dark));padding:26px 24px;text-align:center;border-bottom:3px solid var(--gold)}
.lico{font-size:40px;margin-bottom:8px}
.ltop h2{font-family:'Noto Sans Kannada',sans-serif;color:#fff;font-size:20px;font-weight:700;line-height:1.35}
.ltop p{color:#90b8e8;font-size:12px;margin-top:6px;line-height:1.7;font-family:'Noto Sans Kannada',sans-serif}
.lbody{padding:22px}
.rtabs{display:flex;gap:3px;background:#f1f5f9;border-radius:8px;padding:3px;margin-bottom:17px}
.rtab{flex:1;padding:8px 4px;border:none;border-radius:6px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;background:transparent;color:var(--mut);transition:.2s}
.rtab.on{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(26,61,114,.3)}
.flbl{display:block;font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.fg{margin-bottom:13px}
.fsel,.fin{width:100%;padding:9px 12px;border:1.5px solid var(--bdr);border-radius:8px;font-family:inherit;font-size:14px;color:var(--txt);outline:none;background:#fff;transition:.2s}
.fsel:focus,.fin:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.pr{position:relative}
.pr .fin{padding-right:40px}
.eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--mut);font-size:18px;padding:3px;line-height:1}
.eye:hover{color:var(--blue)}
.err-box,.err{background:#fee2e2;border:1px solid #fca5a5;color:var(--red);padding:8px 12px;border-radius:7px;font-size:12.5px;margin-bottom:12px}
.lbtn{width:100%;padding:11px;background:linear-gradient(135deg,var(--blue),#0d4a8c);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:.22s;letter-spacing:.3px}
.lbtn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(26,61,114,.3)}
.lbtn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}
.spin-sm{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:sp .6s linear infinite;vertical-align:middle;margin-right:5px}
.lfoot{text-align:center;margin-top:16px}
.lfoot p{font-size:11.5px;color:var(--mut);line-height:1.9}

/* ENTRY */
.ew{display:grid;grid-template-columns:238px 1fr;gap:15px;align-items:start}
@media(max-width:700px){.ew{grid-template-columns:1fr}}
.sb{background:var(--card);border-radius:12px;box-shadow:0 3px 16px rgba(0,0,0,.08);overflow:hidden;position:sticky;top:66px}
.sbh{background:linear-gradient(135deg,var(--blue),var(--dark));padding:13px 14px;border-bottom:2px solid var(--gold)}
.sbh h3{font-family:'Noto Serif',serif;color:#fff;font-size:13px}
.sbh p{color:#90b8e8;font-size:11px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sbb{padding:12px 13px}
.sr{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #f1f5f9;font-size:12px}
.sr:last-child{border-bottom:none}
.sl{color:var(--mut);font-weight:600}
.sv{font-weight:700}
.g{color:var(--green)}.a{color:var(--amber)}.b{color:#1d4ed8}
.pbr{display:flex;justify-content:space-between;font-size:11px;color:var(--mut);margin:10px 0 3px}
.pbar{height:7px;background:var(--bdr);border-radius:4px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--green),#22c55e);border-radius:4px;transition:width .5s}
.sst{display:flex;align-items:center;gap:7px;padding:8px 11px;border-radius:8px;margin-top:10px;font-size:12px;font-weight:700}
.sst-ok{background:#f0fdf4;color:#15803d;border:1px solid #86efac}
.sst-no{background:#fffbeb;color:#92400e;border:1px solid #fcd34d}
.sst-err{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dg{background:var(--green)}.da{background:var(--amber);animation:bk .9s infinite}.dr{background:var(--red)}
@keyframes bk{0%,100%{opacity:1}50%{opacity:.2}}
.sbw{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.sbt{padding:8px;border-radius:7px;font-family:inherit;font-size:11.5px;font-weight:700;cursor:pointer;transition:.2s;border:none;text-align:center}
.sbt-rf{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe}.sbt-rf:hover{background:#1d4ed8;color:#fff}
.sbt-rt{background:#fffbeb;color:#92400e;border:1px solid #fcd34d}.sbt-rt:hover{background:var(--amber);color:#fff}
.sbt-lo{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}.sbt-lo:hover{background:var(--red);color:#fff}

/* CONTENT */
.cc{display:flex;flex-direction:column;gap:12px}
.ctop{background:var(--card);border-radius:12px;padding:14px 18px;box-shadow:0 3px 16px rgba(0,0,0,.08)}
.ctop h2{font-family:'Noto Serif',serif;color:var(--blue);font-size:15.5px}
.ctop p{color:var(--mut);font-size:12px;margin-top:3px;line-height:1.5}
.pill{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;margin-top:7px}
.p-ok{background:#dcfce7;color:#15803d}
.p-no{background:#fee2e2;color:#991b1b}
.p-ld{background:#eff6ff;color:#1e40af}
.tw{background:var(--card);border-radius:12px;box-shadow:0 3px 16px rgba(0,0,0,.08);overflow:auto;max-height:calc(100vh - 220px)}
.tld{padding:55px;text-align:center;color:var(--mut)}
.tld .ts{width:34px;height:34px;border:3px solid var(--bdr);border-top-color:var(--blue);border-radius:50%;animation:sp .7s linear infinite;margin:0 auto 12px}
table{width:100%;border-collapse:collapse;min-width:760px}
thead{background:linear-gradient(135deg,var(--blue),var(--dark));position:sticky;top:0;z-index:5}
thead th{padding:10px 9px;text-align:left;font-size:10px;font-weight:700;color:#90b8e8;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;border-right:1px solid rgba(255,255,255,.07)}
thead th:last-child{border-right:none}
tbody td{padding:8px 9px;font-size:13px;color:#334155;vertical-align:middle;border-bottom:1px solid #edf2f8}
.vr{background:#fff}.vr:hover{background:#f8fafc}.vr.dn{background:#f0fdf4}
.dk{background:#faf7ff}.dk:hover{background:#f3eeff}.dk.dn{background:#f0fdf4}
.sno{background:#e2e8f0;color:#475569;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.darr{color:#a78bfa;font-size:15px;font-weight:900}
.vn{font-weight:700;color:var(--txt);font-size:13px}
.dh{font-size:9.5px;color:#a78bfa;margin-top:1px}
.drow{display:flex;align-items:center;gap:6px}
.dl{border-top:2px dashed #c4b5fd;width:13px;flex-shrink:0}
.dnm{font-weight:700;color:#5b21b6;font-size:12.5px}
.dbg{background:#ede9fe;color:#5b21b6;padding:2px 5px;border-radius:3px;font-size:9px;font-weight:700;margin-left:2px}
.gpb{background:#dbeafe;color:#1d4ed8;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700}
.cm{font-family:'Courier New',monospace;font-size:11px;color:#94a3b8}
.ni{width:108px;padding:6px 8px;border:1.5px solid var(--bdr);border-radius:7px;font-family:inherit;font-size:13px;text-align:right;outline:none;transition:.2s;-moz-appearance:textfield;appearance:textfield}
.ni::-webkit-inner-spin-button,.ni::-webkit-outer-spin-button{-webkit-appearance:none}
.ni:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.ni.ok{border-color:var(--green);background:#f0fdf4}
.act{display:flex;align-items:center;gap:5px}
.rd{width:7px;height:7px;border-radius:50%;flex-shrink:0;display:none}
.rd.v{display:inline-block}
.rd-ok{background:var(--green)}.rd-er{background:var(--red)}.rd-sp{background:var(--amber);animation:bk .8s infinite}
.bsv{padding:4px 12px;background:var(--blue);color:#fff;border:none;border-radius:6px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.bsv:hover{background:#0d4a8c}
.bed{padding:4px 10px;background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;border-radius:6px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.bed:hover{background:#1e40af;color:#fff}

/* ADMIN */
.atabs{display:flex;background:var(--card);border-radius:12px 12px 0 0;overflow:hidden}
.atab{flex:1;padding:13px 8px;border:none;font-family:inherit;font-size:12.5px;font-weight:700;cursor:pointer;background:#f8fafc;color:var(--mut);border-bottom:3px solid transparent;transition:.2s;text-align:center}
.atab.on{background:#fff;color:var(--blue);border-bottom-color:var(--blue)}
.atab:hover:not(.on){background:#f1f5f9}
.apnl{background:var(--card);border-radius:0 0 12px 12px;box-shadow:0 4px 20px rgba(0,0,0,.09);padding:22px}
.agrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:11px;margin-bottom:18px}
.ac{background:linear-gradient(135deg,var(--blue),var(--dark));color:#fff;border-radius:11px;padding:15px;position:relative;overflow:hidden}
.ac::after{content:'';position:absolute;right:-8px;bottom:-8px;width:58px;height:58px;border-radius:50%;background:rgba(255,255,255,.07)}
.ai{font-size:23px;margin-bottom:5px}.av{font-size:25px;font-weight:700;line-height:1}.al{font-size:11px;color:#90b8e8;margin-top:3px;font-weight:600}
.ach{height:4px;background:rgba(255,255,255,.2);border-radius:2px;margin-top:8px;overflow:hidden}
.acf{height:100%;background:var(--gold);border-radius:2px;transition:width .5s}
.sh{font-family:'Noto Serif',serif;color:var(--blue);font-size:14px;font-weight:700;margin-bottom:11px}
.pt{width:100%;border-collapse:collapse;font-size:12.5px}
.pt th{background:#f1f5f9;padding:8px 10px;text-align:left;font-weight:700;color:#475569;font-size:10.5px;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--bdr)}
.pt td{padding:8px 10px;border-bottom:1px solid #f5f7fb;vertical-align:middle}
.pt tr:hover td{background:#f8fafc}
.mb{height:7px;background:var(--bdr);border-radius:4px;overflow:hidden;min-width:70px}
.mf{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),#22c55e)}
.bdg{display:inline-block;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700}
.bok{background:#dcfce7;color:#15803d}.bpt{background:#fef9c3;color:#854d0e}.bno{background:#f1f5f9;color:#475569}

/* SETUP */
.sstep{display:flex;gap:13px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px dashed var(--bdr)}
.sstep:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sn{width:30px;height:30px;background:var(--blue);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.sb2 h4{font-size:13.5px;font-weight:700;color:var(--txt);margin-bottom:4px}
.sb2 p,.sb2 li{font-size:12px;color:#475569;line-height:1.65}
.sb2 code{background:#f1f5f9;padding:2px 5px;border-radius:3px;font-family:'Courier New',monospace;font-size:11px;color:var(--blue)}
.sb2 a{color:var(--blue);font-weight:700}
.sb2 ol{padding-left:18px;margin-top:6px}
.sb2 ol li{margin-bottom:4px}
.cw{position:relative;margin-top:8px}
.cb{background:#0f172a;color:#e2e8f0;border-radius:9px;padding:13px;font-family:'Courier New',monospace;font-size:11px;line-height:1.6;max-height:220px;overflow:auto;white-space:pre}
.cpb{position:absolute;top:7px;right:7px;background:var(--blue);color:#fff;border:none;padding:4px 11px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit}
.cpb.ok{background:var(--green)}
.ur{display:flex;gap:7px;margin-top:9px}
.ui{flex:1;padding:9px 11px;border:1.5px solid var(--bdr);border-radius:7px;font-family:inherit;font-size:13px;outline:none;transition:.2s}
.ui:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,61,114,.1)}
.ui.ok{border-color:var(--green);background:#f0fdf4}
.bp{padding:9px 18px;background:var(--blue);color:#fff;border:none;border-radius:7px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap}
.bp:hover{background:#0d4a8c}
.bs{padding:9px 18px;background:#f1f5f9;color:#475569;border:1px solid var(--bdr);border-radius:7px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer}
.bs:hover{background:var(--bdr)}
.inb{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:11px 14px;margin:10px 0;font-size:12.5px;color:#1e40af;line-height:1.6}
.wnb{background:#fef9c3;border:1px solid #fde047;border-radius:8px;padding:11px 14px;margin:10px 0;font-size:12.5px;color:#854d0e;line-height:1.6}
.rbox{padding:9px 12px;border-radius:7px;font-size:12.5px;margin-top:9px;line-height:1.6}
.rbok{background:#f0fdf4;color:#15803d;border:1px solid #86efac}
.rber{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
.rbin{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}

/* FOOTER */
.ftr{text-align:center;padding:18px 14px 12px;margin-top:10px;border-top:1px solid #dce3ed;line-height:1.9}
.f1{font-family:'Noto Serif',serif;font-size:13px;font-weight:700;color:var(--blue)}
.f2{font-size:12px;color:#475569}.f2 strong{color:var(--blue)}
.f3{font-size:11px;color:#94a3b8;margin-top:1px}

/* TOAST */
#toast{position:fixed;bottom:18px;right:18px;padding:10px 17px;border-radius:9px;font-size:13px;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.22);z-index:9999;pointer-events:none;opacity:0;transform:translateY(12px);transition:.25s;max-width:300px}
#toast.show{opacity:1;transform:translateY(0)}
.tok{background:var(--green);color:#fff}.tbad{background:var(--red);color:#fff}.tinfo{background:var(--blue);color:#fff}.twrn{background:var(--amber);color:#fff}
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="ov" class="hi">
  <div class="sp"></div>
  <p id="ov-msg">Loading‚Ä¶</p>
</div>

<!-- HEADER -->
<header class="hdr"><div class="hdr-in">
  <div class="seal">üèõÔ∏è</div>
  <div class="hdr-t">
    <h1>‡≤ú‡≤®‡≤ó‡≤£‡≤§‡≤ø 2027 ‚Äî ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø ‡≤∏‡≤Ç‡≤ó‡≥ç‡≤∞‡≤π‡≤£ ‡≤™‡≥ã‡≤∞‡≥ç‡≤ü‡≤≤‡≥ç</h1>
    <p>‡≤Æ‡≤≥‡≤µ‡≤≥‡≥ç‡≤≥‡≤ø ‡≤§‡≤æ‡≤≤‡≥ç‡≤≤‡≥Ç‡≤ï‡≥Å ¬∑ ‡≤Æ‡≤Ç‡≤°‡≥ç‡≤Ø ‡≤ú‡≤ø‡≤≤‡≥ç‡≤≤‡≥Ü ¬∑ Karnataka Government</p>
  </div>
  <div class="hdr-r">
    <div id="hdr-s">
      <span id="hdr-chip" class="chip cv"></span>
      <span id="hdr-nm" class="hnm"></span>
      <button class="blo" onclick="doLogout()">‚Üê Logout</button>
    </div>
  </div>
</div></header>

<!-- ‚ïê‚ïê LOGIN PAGE ‚ïê‚ïê -->
<div class="pg" id="pg-login">
  <div class="lw"><div class="lcard">
    <div class="ltop">
      <div class="lico">üìã</div>
      <h2>Census 2027</h2>
      <p>Village Population Data Entry Portal<br>Malavalli Taluk ¬∑ Mandya District</p>
    </div>
    <div class="lbody">
      <div class="rtabs">
        <button class="rtab on" id="tb-v" onclick="setRole('vao')">üë§ VAO</button>
        <button class="rtab" id="tb-s" onclick="setRole('sec')">üè¢ Secretary</button>
        <button class="rtab" id="tb-a" onclick="setRole('adm')">‚öô Admin</button>
      </div>
      <div class="err-box hi" id="lerr"></div>
      <div class="fg hi" id="ng">
        <label class="flbl" id="nlbl">VAO Name</label>
        <select class="fsel" id="nsel"><option value="">-- Select --</option></select>
      </div>
      <div class="fg">
        <label class="flbl">Password</label>
        <div class="pr">
          <input class="fin" type="password" id="pwd" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/>
          <button class="eye" onclick="toggleEye()" id="eyeb">üëÅ</button>
        </div>
      </div>
      <button class="lbtn" id="lbtn" onclick="doLogin()">Login ‚Üí</button>
    </div>
  </div>
  <div class="lfoot">
    <p>Designed &amp; Developed by <strong>Gangadhar</strong><br>
    Statistical Inspector, Taluk Office Malavalli, Mandya<br>
    <span style="font-size:10.5px;color:#94a3b8">¬© 2027 ¬∑ For official government use only</span></p>
  </div></div>
</div>

<!-- ‚ïê‚ïê ENTRY PAGE ‚ïê‚ïê -->
<div class="pg hi" id="pg-entry">
  <div class="ew">
    <!-- Sidebar -->
    <div class="sb">
      <div class="sbh"><h3 id="sb-t">VAO Panel</h3><p id="sb-n"></p></div>
      <div class="sbb">
        <div class="sr"><span class="sl">Role</span><span class="sv b" id="sb-r"></span></div>
        <div class="sr"><span class="sl">Villages</span><span class="sv" id="sb-v"></span></div>
        <div class="sr"><span class="sl">Total Rows</span><span class="sv" id="sb-tc"></span></div>
        <div class="sr"><span class="sl">Saved</span><span class="sv" id="sb-dc"></span></div>
        <div class="sr"><span class="sl">Synced ‚òÅ</span><span class="sv" id="sb-sc"></span></div>
        <div class="pbr"><span>Progress</span><span id="pb-p">0%</span></div>
        <div class="pbar"><div class="pf" id="pf" style="width:0%"></div></div>
        <div class="sst sst-no" id="sst">
          <span class="dot da"></span><span id="sst-t">Connecting‚Ä¶</span>
        </div>
        <div class="sbw">
          <button class="sbt sbt-rf" onclick="refreshData()">üîÑ Refresh from Sheets</button>
          <button class="sbt sbt-rt hi" id="brty" onclick="retryFailed()">‚Ü© Retry Failed</button>
          <button class="sbt sbt-lo" onclick="doLogout()">‚Üê Logout</button>
        </div>
      </div>
    </div>
    <!-- Main -->
    <div class="cc">
      <div class="ctop">
        <h2 id="ct-h">Data Entry</h2>
        <p id="ct-p"></p>
        <span class="pill p-no hi" id="pno">‚ö† Google Sheets not configured ‚Äî contact Admin</span>
        <span class="pill p-ok hi" id="pok">‚òÅ Live ‚Äî every Save writes to Google Sheets instantly</span>
        <span class="pill p-ld hi" id="pld">‚è≥ Loading data from Google Sheets‚Ä¶</span>
      </div>
      <div class="tw">
        <div class="tld" id="tld"><div class="ts"></div><p>Loading data from Google Sheets‚Ä¶</p></div>
        <table class="hi" id="dtbl">
          <thead><tr>
            <th style="width:30px">#</th><th>Code</th><th>Village / Dakale Grama</th>
            <th id="th-gp">GP</th><th id="th-po">Population</th><th id="th-hh">House Holds</th>
            <th id="th-blk" style="width:90px" title="‡≤∏‡≥Å‡≤Æ‡≤æ‡≤∞‡≥Å 700-800 ‡≤ú‡≤®‡≤∞ ‡≤Ö‡≤ß‡≤æ‡≤∞‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¨‡≥ç‡≤≤‡≤æ‡≤ï‡≥ç‚Äå ‡≤Æ‡≤æ‡≤°‡≤¨‡≤π‡≥Å‡≤¶‡≥Å">Blocks*</th>
            <th style="width:108px">Action</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div style="font-size:11px;color:var(--mut);padding:8px 14px;background:#f8fafc;border-top:1px solid var(--bdr)">
        * <strong>Blocks</strong> = ‡≤∏‡≥Å‡≤Æ‡≤æ‡≤∞‡≥Å 700-800 ‡≤ú‡≤®‡≤∞ ‡≤Ö‡≤ß‡≤æ‡≤∞‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¨‡≥ç‡≤≤‡≤æ‡≤ï‡≥ç‚Äå ‡≤Æ‡≤æ‡≤°‡≤¨‡≤π‡≥Å‡≤¶‡≥Å ¬∑ Auto-calculated from Population √∑ 750 ¬∑ Can be edited manually
      </div>
    </div>
  </div>
  <div class="ftr">
    <div class="f1">Census 2027 ‚Äî Village Population Data Entry System</div>
    <div class="f2">Designed &amp; Developed by <strong>Gangadhar</strong>, Statistical Inspector ¬∑ Taluk Office Malavalli, Mandya</div>
    <div class="f3">¬© 2027 All rights reserved ¬∑ For official government use only</div>
  </div>
</div>

<!-- ‚ïê‚ïê ADMIN PAGE ‚ïê‚ïê -->
<div class="pg hi" id="pg-admin">
  <div class="atabs">
    <button class="atab on" id="at0" onclick="aTab(0)">üìä Live Progress</button>
    <button class="atab" id="at1" onclick="aTab(1)">‚òÅ Sheets Setup</button>
  </div>

  <!-- TAB 0 -->
  <div class="apnl" id="ap0">
    <div class="agrid" id="acards">
      <div class="ac"><div class="ai">‚è≥</div><div class="av">‚Äî</div><div class="al">Loading‚Ä¶</div></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
      <button class="bp" onclick="adminLoad()">üîÑ Refresh from Google Sheets</button>
      <span id="last-ref" style="font-size:12px;color:var(--mut)"></span>
    </div>
    <div class="sh">üìã VAO-wise Completion</div>
    <div style="overflow:auto;margin-bottom:18px">
      <table class="pt"><thead><tr><th>#</th><th>VAO</th><th>Villages</th><th>VAO Done</th><th>Sec Done</th><th>Progress</th><th>Status</th></tr></thead>
      <tbody id="vtbody"></tbody></table>
    </div>
    <div class="sh">üèò All Villages (live from Google Sheets)</div>
    <div style="overflow:auto;max-height:320px">
      <table class="pt"><thead><tr><th>#</th><th>Code</th><th>Village</th><th>VAO</th><th>GP</th><th>Pop(VAO)</th><th>HH(VAO)</th><th>Blk(VAO)</th><th>Pop(Sec)</th><th>HH(Sec)</th><th>Blk(Sec)</th></tr></thead>
      <tbody id="iltbody"></tbody></table>
    </div>
  </div>

  <!-- TAB 1 -->
  <div class="apnl hi" id="ap1">
    <div class="inb">
      <strong>Architecture:</strong> Google Sheets is the <strong>only database</strong>. Every login fetches all data from Sheets. Every Save writes directly to Sheets. Data is identical on all devices, always. ‚úÖ
    </div>

    <div class="sstep">
      <div class="sn">1</div>
      <div class="sb2">
        <h4>Create a Google Sheet</h4>
        <p>Open <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> ‚Üí <strong>+ Blank</strong><br>
        Name it: <strong>"Census 2027 Malavalli"</strong><br>
        The script creates all 17 columns automatically on first Save.</p>
      </div>
    </div>

    <div class="sstep">
      <div class="sn">2</div>
      <div class="sb2">
        <h4>Open Apps Script &amp; Paste the Code</h4>
        <p>In the sheet: <strong>Extensions ‚Üí Apps Script</strong><br>
        Select all existing code (Ctrl+A) ‚Üí Delete ‚Üí Paste the script below ‚Üí <strong>Ctrl+S</strong> to save.</p>
        <div class="cw">
          <pre class="cb" id="sbox"></pre>
          <button class="cpb" id="cpb" onclick="cpScript()">Copy</button>
        </div>
      </div>
    </div>

    <div class="sstep">
      <div class="sn">3</div>
      <div class="sb2">
        <h4>Deploy as Web App (critical settings)</h4>
        <ol>
          <li>Click <strong>Deploy</strong> (top right) ‚Üí <strong>New deployment</strong></li>
          <li>Click the ‚öô gear icon ‚Üí select <strong>Web app</strong></li>
          <li>Execute as: <strong>Me</strong></li>
          <li>Who has access: <strong>Anyone</strong> ‚Üê must be exactly this, not "anyone with Google account"</li>
          <li>Click <strong>Deploy</strong> ‚Üí popup: <strong>Authorize access</strong> ‚Üí choose your Google account ‚Üí <strong>Allow</strong></li>
          <li>Copy the <strong>Web App URL</strong> (starts with <code>https://script.google.com/macros/s/</code>)</li>
        </ol>
      </div>
    </div>

    <div class="sstep">
      <div class="sn">4</div>
      <div class="sb2">
        <h4>Paste URL &amp; Verify</h4>
        <p>Paste the Web App URL below ‚Üí click "Open in Tab" ‚Üí you should see <code>{"ok":true,"rows":[]}</code></p>
        <div class="ur">
          <input class="ui" type="text" id="ui" placeholder="https://script.google.com/macros/s/‚Ä¶/exec"/>
          <button class="bp" onclick="saveUrl()">Save</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button class="bs" onclick="openTab()">üåê Open in New Tab ‚Üí</button>
          <button class="bs" style="background:#f0fdf4;color:#15803d;border-color:#86efac" onclick="markConn()">‚úì It shows {"ok":true} ‚Äî Mark Connected</button>
        </div>
        <div id="ures" class="hi"></div>
        <div id="uok" class="hi" style="margin-top:9px;padding:9px 13px;background:#f0fdf4;border:1px solid #86efac;border-radius:7px;color:#15803d;font-size:12.5px;font-weight:700">
          ‚úÖ Connected! Now download and re-host the app so all users sync automatically.
        </div>
      </div>
    </div>

    <div class="sstep">
      <div class="sn">5</div>
      <div class="sb2">
        <h4>Download &amp; Host on GitHub Pages (Free)</h4>
        <p>Download downloads the app with your Sheet URL <strong>permanently embedded</strong>.<br>
        Upload to GitHub ‚Äî every VAO/Secretary on any device syncs automatically, no setup needed.</p>
        <button class="bp" style="margin-top:10px" onclick="dlApp()">‚¨á Download App (URL baked in)</button>
        <div class="wnb" style="margin-top:12px">
          <strong>GitHub Pages (no commands needed):</strong><br>
          1. <a href="https://github.com" target="_blank">github.com</a> ‚Üí Sign up free ‚Üí New repository ‚Üí name: <code>census-2027</code> ‚Üí Public ‚Üí Create<br>
          2. Add file ‚Üí Upload ‚Üí upload downloaded <code>census2027.html</code> ‚Üí Commit changes<br>
          3. Click the file ‚Üí pencil ‚úè icon ‚Üí rename to <code>index.html</code> ‚Üí Commit changes<br>
          4. Settings ‚Üí Pages ‚Üí Source: <strong>main</strong> ‚Üí Save<br>
          5. Live at: <code>https://YOUR-USERNAME.github.io/census-2027/</code> within 2 minutes
        </div>
        <div class="inb">
          üí° <strong>To update later:</strong> Download again (with current URL) ‚Üí go to github.com ‚Üí your repo ‚Üí click <code>index.html</code> ‚Üí pencil ‚úè ‚Üí paste new content ‚Üí Commit. Done in 60 seconds.
        </div>
      </div>
    </div>

    <div class="sstep">
      <div class="sn">6</div>
      <div class="sb2">
        <h4>Apps Script File for GitHub (optional)</h4>
        <p>You can also version-control the Apps Script. Download it as a <code>.gs</code> file to keep as backup or share with others. This file cannot be run directly ‚Äî it must be pasted into Google Apps Script.</p>
        <button class="bs" style="margin-top:8px" onclick="dlScript()">‚¨á Download Apps Script (.gs file)</button>
      </div>
    </div>

  </div><!-- ap1 -->

  <div class="ftr">
    <div class="f1">Census 2027 ‚Äî Village Population Data Entry System</div>
    <div class="f2">Designed &amp; Developed by <strong>Gangadhar</strong>, Statistical Inspector ¬∑ Taluk Office Malavalli, Mandya</div>
    <div class="f3">¬© 2027 All rights reserved ¬∑ For official government use only</div>
  </div>
</div>

<div id="toast"></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CENSUS 2027 ¬∑ MALAVALLI TALUK
//  Architecture: Google Sheets = single source of truth
//  Every login ‚Üí fetch all data from Sheets
//  Every Save ‚Üí write to Sheets ‚Üí confirm ‚Üí update UI
//  No localStorage for data. All devices always identical.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Hashed passwords (SHA-256 + salt 'C27ML') ‚Äî plaintext never stored
const UH = 'b8a78073683ce92133ce62b69c9bad9a59a313a19c95ba27d1c2c31fcddbe44e';
const AH = 'f100e61428f8a548cb63ae5354fddf266f4359f5a98ece3ac7e737bf3c9db4eb';

// BAKED_URL: Admin fills via Setup tab then downloads ‚Äî baked so all devices auto-connect
// Replace __SHEET_URL__ with your deployed Apps Script URL when hosting on GitHub
const BAKED = 'https://script.google.com/macros/s/AKfycbwLxozuuFmusrfCHPT3cIfNRvY2KjKbsnYe_kzgPEKZRsa-7B_Dx1-XhzXnYAOXqqTI/exec';

// ‚îÄ‚îÄ Village data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VILLAGES=[
  {sno:1,code:614654,name:"Chikkamulagudu",dk:"Vaddara Kaloni",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:2,code:649474,name:"Kurubanapura",dk:"",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:3,code:614655,name:"Veerajipura",dk:"",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:4,code:614656,name:"Maganahalli",dk:"",vao:"KAVYA",gp:"Mikkere"},
  {sno:5,code:614657,name:"Mikkere",dk:"",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:6,code:614658,name:"Ramandur",dk:"Chunchagowdanakoppalu",vao:"MANJUNATH M V",gp:"Mikkere"},
  {sno:7,code:614659,name:"Anasale",dk:"Ramanathamole",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:8,code:649529,name:"Halladakoppalu",dk:"",vao:"SHAFI",gp:"Chikkamulagudu"},
  {sno:9,code:614660,name:"Bheemanahalli",dk:"",vao:"GURURAJ",gp:"Chikkamulagudu"},
  {sno:10,code:614661,name:"Hittanahalli",dk:"1)Hittanahalli Koppalu 2)Budukegowdanadoddi",vao:"GURURAJ",gp:"Hittanahalli"},
  {sno:11,code:614662,name:"Dugganahalli",dk:"1)Hanchipura 2)Muddegowdanadoddi",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:12,code:614663,name:"Devipura",dk:"Jayachamarajapura",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:13,code:614664,name:"Thalagavadi",dk:"",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:14,code:614665,name:"Kagepura",dk:"",vao:"PRAKASHA",gp:"Talagavadi"},
  {sno:15,code:614666,name:"Koregala",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:16,code:614667,name:"Maganur",dk:"Maganuru Kaloni",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:17,code:614668,name:"Settahalli",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:18,code:614669,name:"Muganakoppalu",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Lingapatna"},
  {sno:19,code:614670,name:"Ganiganapura",dk:"",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:20,code:614671,name:"Sasiyalapura",dk:"Gattikoppalu",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:21,code:614672,name:"Madahalli",dk:"",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:22,code:614673,name:"Hullegala",dk:"",vao:"KAVADI DHANANJAYA",gp:"Dugganahalli"},
  {sno:23,code:614674,name:"Bandurukaval",dk:"",vao:"AKSHAY KUMAR",gp:"Settihalli"},
  {sno:24,code:614675,name:"Banduru",dk:"Dadadapura",vao:"JAYANTH B N",gp:"Bandur"},
  {sno:25,code:614676,name:"Kallarepura",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Bandur"},
  {sno:26,code:614677,name:"Nenanuru",dk:"",vao:"PRATHIMA SM",gp:"Sujjalur"},
  {sno:27,code:614678,name:"Markalu",dk:"1)Kodenakoppalu 2)Aladahalli",vao:"PRATHIMA SM",gp:"Hittanahalli"},
  {sno:28,code:651553,name:"Jadaganapura",dk:"",vao:"PRATHIMA SM",gp:"Hittanahalli"},
  {sno:29,code:614679,name:"Doranahalli",dk:"",vao:"GURURAJ",gp:"Mikkere"},
  {sno:30,code:614680,name:"Kirugavalu",dk:"Chikkegowdanadoddi",vao:"SHAFI",gp:"Kirugavalu"},
  {sno:31,code:614681,name:"Deshavalli",dk:"",vao:"KAVYA",gp:"Bendaravadi"},
  {sno:32,code:614682,name:"Bendaravadi",dk:"",vao:"KAVYA",gp:"Bendaravadi"},
  {sno:33,code:614683,name:"Honaganahalli",dk:"",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:34,code:614684,name:"Kalkuni",dk:"1)Puttegowdanakoppalu 2)Chikkamaligekoppalu",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:35,code:651353,name:"Doddegowdanakoppalu",dk:"",vao:"ANIL JAMAKHANDI",gp:"Kalkuni"},
  {sno:36,code:614685,name:"Huvinakoppalu",dk:"",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:37,code:614686,name:"Sujjalur",dk:"1)Channapillekoppalu 2)Nanjegowdanadoddi",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:38,code:651447,name:"Samshettipura",dk:"",vao:"ANIL JAMAKHANDI",gp:"Sujjalur"},
  {sno:39,code:614687,name:"Uppanahalli",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Settihalli"},
  {sno:40,code:614688,name:"Yamadurukaval",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:41,code:614689,name:"Yamaduru",dk:"",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:42,code:614690,name:"Ragibommanahalli",dk:"Hucchanadoddi",vao:"HANAMANTARAYA BOGONDI",gp:"Ragibommanahalli"},
  {sno:43,code:614691,name:"Ganaganuru",dk:"",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:44,code:614692,name:"Hangrapura",dk:"",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:45,code:614693,name:"Avverahalli",dk:"Vadakepura",vao:"PUNEETH KUMAR N",gp:"Ragibommanahalli"},
  {sno:46,code:614694,name:"Kebbepura",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:47,code:614695,name:"Maliyur",dk:"Uppagerikoppalu",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:48,code:651355,name:"Nelligere",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:49,code:614696,name:"Hanakola",dk:"",vao:"PUNEETH KUMAR N",gp:"Sujjalur"},
  {sno:50,code:614697,name:"Basavana Halli",dk:"",vao:"PUNEETH KUMAR N",gp:"Purigali"},
  {sno:51,code:614698,name:"Surakahalli",dk:"",vao:"PUNEETH KUMAR N",gp:"Purigali"},
  {sno:52,code:614699,name:"Nelamakanahalli",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:53,code:654905,name:"Hombegowdanadoddi",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:54,code:654906,name:"Bhugathagahalli",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:55,code:614700,name:"Appugowdana Halli",dk:"Kalakempanadoddi",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:56,code:651356,name:"Nelluru",dk:"",vao:"CHAITHRA K",gp:"Nelamakanahalli"},
  {sno:57,code:614701,name:"Kaluveeranahalli",dk:"Moledoddi",vao:"USMAN BHASHA",gp:"Kandegala"},
  {sno:58,code:614702,name:"Kandegala",dk:"",vao:"USMAN BHASHA",gp:"Kandegala"},
  {sno:59,code:614703,name:"Gulagatta",dk:"",vao:"USMAN BHASHA",gp:"Nelamakanahalli"},
  {sno:60,code:614704,name:"Malavalli(Rural)",dk:"Tammadahalli",vao:"NANDEESH",gp:"Marehalli"},
  {sno:61,code:614705,name:"Nidaghatta",dk:"Kyathegowdanadoddi",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:62,code:651360,name:"Cholanahalli",dk:"",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:63,code:614706,name:"Ankanahalli",dk:"Anchedoddi",vao:"NATARAJ B",gp:"Kandegala"},
  {sno:64,code:614707,name:"Gowdagere",dk:"",vao:"SIDRAMAPPA",gp:"Nidaghatta"},
  {sno:65,code:614708,name:"Amrutheswaranahalli",dk:"",vao:"SIDRAMAPPA",gp:"Kandegala"},
  {sno:66,code:614709,name:"Kembuthagere",dk:"K. Annahalli",vao:"SIDRAMAPPA",gp:"Agasnapura"},
  {sno:67,code:614710,name:"Sahalli",dk:"",vao:"SIDRAMAPPA",gp:"Agasnapura"},
  {sno:68,code:614711,name:"Hadli",dk:"",vao:"RAVEESH M",gp:"Haadli"},
  {sno:69,code:614712,name:"Kodipura",dk:"",vao:"RAVEESH M",gp:"Agasnapura"},
  {sno:70,code:614713,name:"Koonanapura",dk:"",vao:"RAVEESH M",gp:"Haadli"},
  {sno:71,code:614714,name:"Jogipura",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Agasnapura"},
  {sno:72,code:614715,name:"Agasanapura",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Agasnapura"},
  {sno:73,code:614716,name:"Banagahalli",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:74,code:614717,name:"Chandupura",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:75,code:614718,name:"M.Shivapura",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:76,code:614719,name:"Huskur",dk:"1)Hucchegowdanadoddi 2)Appajayanadoddi 3)Kulumedoddi 4)Siddapura",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:77,code:614720,name:"Kaladevanahalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:78,code:614721,name:"Hosapura",dk:"Gollaradoddi",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:79,code:614722,name:"Aslishivapura",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:80,code:614723,name:"Belathur",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:81,code:614724,name:"Yethambadi",dk:"",vao:"ABHIJITH N L",gp:"Yathambadi"},
  {sno:82,code:614725,name:"Antharavalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:83,code:614726,name:"Hullahalli",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Yathambadi"},
  {sno:84,code:614727,name:"Channipura",dk:"",vao:"RAVEESH M",gp:"D.Halasahalli"},
  {sno:85,code:614728,name:"Hullagala",dk:"",vao:"SHIVASHANKAR B JAMAKANDI",gp:"Huskur"},
  {sno:86,code:614729,name:"Dadamahalli",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:87,code:614730,name:"Kiragasur",dk:"",vao:"KENCHAPPA KODLIWWAD",gp:"Yathambadi"},
  {sno:88,code:614731,name:"Banasamudra",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:89,code:614732,name:"Kaggalipura",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:90,code:614733,name:"Konnapura",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:91,code:614734,name:"Halasahalli",dk:"",vao:"BHASKAR S",gp:"D.Halasahalli"},
  {sno:92,code:614735,name:"Dhanagur",dk:"",vao:"SHIVAPPA DAMANALA",gp:"Dhanaguru"},
  {sno:93,code:614736,name:"Linganapura",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:94,code:614737,name:"Gramadevathepura",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Dhanaguru"},
  {sno:95,code:614738,name:"Basavanpura",dk:"",vao:"RAVEESH M",gp:"D.Halasahalli"},
  {sno:96,code:614739,name:"Nadakalapura",dk:"Nanjegowdanadoddi",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:97,code:614740,name:"Megalapura",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:98,code:614741,name:"Kamsagara",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:99,code:614742,name:"Thuraganur",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:100,code:614743,name:"Attuvanahalli",dk:"",vao:"SUDARSHAN KUMAR PS",gp:"Haadli"},
  {sno:101,code:614744,name:"Alada Halli",dk:"",vao:"PRAVEEN KUMAR M",gp:"Haadli"},
  {sno:102,code:614745,name:"Gajanur",dk:"Sunnadadoddi",vao:"MADEVI J",gp:"Nidaghatta"},
  {sno:103,code:614746,name:"Voddarahalli",dk:"1)Channegowdanadoddi 2)Annekoppalu",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:104,code:614747,name:"Marehalli",dk:"1)Bosegowdanadoddi 2)Nagegowdanadoddi",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:105,code:614748,name:"Ravani",dk:"Lakshmipuradoddi",vao:"MALLESH KP",gp:"Kyathnahalli"},
  {sno:106,code:614749,name:"Devalinganapura",dk:"",vao:"NATARAJ B",gp:"Marehalli"},
  {sno:107,code:614750,name:"Savandipura",dk:"",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:108,code:614751,name:"Sagyasaragur",dk:"1)Honnemaradadoddi 2)Siddapura Kaloni",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:109,code:614752,name:"Nitturhalasahalli",dk:"",vao:"NARASAPPA",gp:"Nitturu"},
  {sno:110,code:614753,name:"Kunthur",dk:"",vao:"NARASAPPA",gp:"Lingapatna"},
  {sno:111,code:614754,name:"Lingapatna",dk:"1)Naripura 2)Moogegowdanadoddi",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:112,code:614755,name:"Nittur",dk:"1)N Hosadoddi 2)Kumbegowdanadoddi",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:113,code:658634,name:"B Hosuru",dk:"",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:114,code:614756,name:"Ankanahalli",dk:"Buyyanadoddi",vao:"SIDDARAYAMALI",gp:"Nitturu"},
  {sno:115,code:614757,name:"Maragowdanahalli",dk:"1)Kuntanadoddi 2)Heggodlu",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:116,code:614758,name:"Nitthur Kodihalli",dk:"",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:117,code:614759,name:"Karadahalli",dk:"",vao:"SIDDARAYAMALI",gp:"Lingapatna"},
  {sno:118,code:614760,name:"Vodeyarabasapura",dk:"Odubasappanadoddi",vao:"SOMANNA",gp:"Thorekadanahalli"},
  {sno:119,code:614761,name:"Handanahalli",dk:"",vao:"SOMANNA",gp:"Lingapatna"},
  {sno:120,code:614762,name:"Kodipura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:121,code:614763,name:"Veerajithimmanadoddi",dk:"Vaddaradoddi",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:122,code:614764,name:"Juganahalli",dk:"1)Doddegownadoddi 2)Benamanahalli",vao:"SOMASHEKAR P",gp:"Lingapatna"},
  {sno:123,code:614765,name:"Balehonniga",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:124,code:614766,name:"Dalavaikodihalli",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:125,code:614767,name:"Deveerahalli",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:126,code:614768,name:"Kempainadoddi",dk:"",vao:"SOMASHEKAR P",gp:"Dalavayikodihalli"},
  {sno:127,code:614769,name:"Nandipura",dk:"",vao:"SOMASHEKAR P",gp:"H Basavapura"},
  {sno:128,code:614770,name:"Gundapura",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:129,code:614771,name:"Hosapetebasavapura",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:130,code:614772,name:"Hagadur",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:131,code:614773,name:"Shivanahalli",dk:"",vao:"LATHA G",gp:"H Basavapura"},
  {sno:132,code:614774,name:"Gollarahalli",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:133,code:614775,name:"Halaguru",dk:"1)Konnapura 2)Valageredoddi",vao:"SOMANNA",gp:"Halaguru"},
  {sno:134,code:614776,name:"Halaganadoddi",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:135,code:614777,name:"Chillapura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:136,code:614778,name:"Thorekadanahalli",dk:"",vao:"BHASKAR S",gp:"Thorekadanahalli"},
  {sno:137,code:614779,name:"Nanjapura",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:138,code:614780,name:"Chikkayelachagere",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:139,code:614781,name:"Halagapura",dk:"",vao:"LATHA G",gp:"Thorekadanahalli"},
  {sno:140,code:614782,name:"Doddayelachagere",dk:"",vao:"LATHA G",gp:"Bydarahalli"},
  {sno:141,code:614783,name:"Madahalli",dk:"",vao:"LATHA G",gp:"Dugganahalli"},
  {sno:142,code:614784,name:"Ganalu",dk:"1)Masteradoddi 2)Kenchaboyidoddi 3)Kodlayyanadoddi 4)Beeruta 5)Konnapura Doddi 6)Tagadayyanadoddi 7)Ganagalu Hosadoddi 8)Karigowdanadoddi 9)Marijogidoddi 10)Beerappanadoddi 11)Guligowdanadoddi 12)Shakunidoddi 13)Byalamaradadoddi",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:143,code:614785,name:"Bydarahalli",dk:"1)Krushnegowdanadoddi 2)Hosadoddi 3)Soligaradoddi",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:144,code:651365,name:"Karalakattedoddi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:145,code:614786,name:"Muthalakatte",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:146,code:614787,name:"Solaba",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:147,code:614788,name:"Basavanahalli",dk:"",vao:"SOMASHEKAR P",gp:"H Basavapura"},
  {sno:148,code:614789,name:"Basavana Betta Forest",dk:"",vao:"NARASAPPA",gp:"H Basavapura"},
  {sno:149,code:614790,name:"Dalanakatte",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:150,code:614791,name:"Basavegowdanadoddi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:151,code:614792,name:"Talavadi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:152,code:614793,name:"Majjigemallanahatti",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:153,code:614794,name:"Muthathi",dk:"",vao:"NARASAPPA",gp:"Bydarahalli"},
  {sno:154,code:614795,name:"Doddaboovalli",dk:"",vao:"RUKSAR FARHEEN",gp:"Kyathnahalli"},
  {sno:155,code:614796,name:"Kyathanahalli",dk:"",vao:"RUKSAR FARHEEN",gp:"Kyathnahalli"},
  {sno:156,code:614797,name:"Kundur",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:157,code:614798,name:"Shiramalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:158,code:614799,name:"Pandithahalli",dk:"",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:159,code:614800,name:"Bachanahalli",dk:"",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:160,code:614801,name:"Manchanapura",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:161,code:614802,name:"Chottanahalli",dk:"1)Kenchanadoddi 2)Chikkanadoddi",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:162,code:651318,name:"Kunanakoppalu",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:163,code:614803,name:"Chandahalli",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:164,code:651422,name:"Varadarajaswamydoddi",dk:"",vao:"MADHU M",gp:"Chottenahalli"},
  {sno:165,code:614804,name:"Dabbahalli",dk:"",vao:"LAVANYA",gp:"Dhanaguru"},
  {sno:166,code:614805,name:"Netkal",dk:"Shimshapura",vao:"LAVANYA",gp:"Chottenahalli"},
  {sno:167,code:614806,name:"Mallikyathanahalli",dk:"Bluff(Shivanasamudra)",vao:"LANKESH H S",gp:"Hosahalli"},
  {sno:168,code:614807,name:"Belakavadi",dk:"1)Anthrayanapuradadoddi 2)Bannithalekoppalu",vao:"LANKESH H S",gp:"Belakavadi"},
  {sno:169,code:651558,name:"Javaganahalli",dk:"",vao:"LANKESH H S",gp:"Belakavadi"},
  {sno:170,code:614808,name:"Kiragasur",dk:"",vao:"LANKESH H S",gp:"Kaggalipura"},
  {sno:171,code:614809,name:"Vasuvalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kaggalipura"},
  {sno:172,code:614810,name:"Hokkarahalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kaggalipura"},
  {sno:173,code:614811,name:"Nanjanayanapura",dk:"",vao:"SHRIKANTH KOTYAL",gp:"B.G.Pura"},
  {sno:174,code:614812,name:"Dyavapatna",dk:"",vao:"SHRIKANTH KOTYAL",gp:"B.G.Pura"},
  {sno:175,code:614813,name:"Hosahalli",dk:"",vao:"PRAVEEN T K",gp:"Hosahalli"},
  {sno:176,code:614814,name:"Hebbani",dk:"",vao:"MADHU M",gp:"Pandithahalli"},
  {sno:177,code:614815,name:"Manchanahalli",dk:"",vao:"MADHU M",gp:"Pandithahalli"},
  {sno:178,code:614816,name:"Dasanadoddi",dk:"Hosadoddi",vao:"PRAVEEN T K",gp:"Pandithahalli"},
  {sno:179,code:614817,name:"Kanchugahalli",dk:"Narayanapura",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:180,code:614818,name:"Malagalali",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:181,code:614819,name:"Thenkahalli",dk:"",vao:"SHRIKANTH KOTYAL",gp:"Kundur"},
  {sno:182,code:614820,name:"Kadabahalli",dk:"Kalyanikoppalu",vao:"MADHU M",gp:"Sarguru"},
  {sno:183,code:614821,name:"Mallinathapura",dk:"",vao:"MADHU M",gp:"Kyathnahalli"},
  {sno:184,code:614822,name:"Kaggala",dk:"",vao:"MADHU M",gp:"Kyathnahalli"},
  {sno:185,code:614823,name:"Kanikahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:186,code:614824,name:"Udape Boovalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:187,code:614825,name:"Thigadahalli",dk:"Konanakoppalu",vao:"SUBHASH",gp:"Kundur"},
  {sno:188,code:614826,name:"Boppagowdanapura",dk:"Utturu",vao:"SUDEEP KUMAR V",gp:"B.G.Pura"},
  {sno:189,code:614827,name:"Muttanahalli",dk:"",vao:"SUBHASH",gp:"B.G.Pura"},
  {sno:190,code:614828,name:"Saraguru",dk:"1)Ainorahundi 2)Halagattekoppalu 3)Agasaragoddi 4)Manchanakoppalu",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:191,code:614829,name:"Hanavadi",dk:"",vao:"SRINIVASAMURTHY",gp:"Sarguru"},
  {sno:192,code:614830,name:"Purigali",dk:"Akkamallanahundi",vao:"SANJAY K",gp:"Purigali"},
  {sno:193,code:614831,name:"Hullamballi",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:194,code:614832,name:"Chikka Abbagilu",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:195,code:614833,name:"Chikkabagiluhanta",dk:"",vao:"SANJAY K",gp:"Purigali"},
  {sno:196,code:614834,name:"Maralahalli",dk:"",vao:"SRINIVASMURTHY",gp:"Purigali"},
  {sno:197,code:614835,name:"Ballagere",dk:"",vao:"SANJAY K",gp:"Sarguru"},
  {sno:198,code:614836,name:"Somanahalli",dk:"Bilijagalimole",vao:"SANJAY K",gp:"Sarguru"},
  {sno:199,code:614837,name:"Kodagahalli",dk:"",vao:"SUBHASH",gp:"B.G.Pura"},
  {sno:200,code:614838,name:"Haladasanahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
  {sno:201,code:614839,name:"Kaggalipura",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
  {sno:202,code:651342,name:"Honaganahalli",dk:"",vao:"SRINIVASAMURTHY",gp:"Kaggalipura"},
];

// ‚îÄ‚îÄ Apps Script source (for download as .gs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GS_CODE = `// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CENSUS 2027 ¬∑ MALAVALLI TALUK ¬∑ APPS SCRIPT
//  Deploy: Extensions ‚Üí Apps Script ‚Üí paste ‚Üí Deploy ‚Üí Web App
//  Execute as: Me | Who has access: Anyone
//  After deploying: copy the /exec URL ‚Üí paste in Admin ‚Üí Setup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var SHEET_NAME = "Census2027";
var COLS = [
  "RowID","SNO","VillageCode","VillageName","RowType","DakaleGrama",
  "VAOName","GPName",
  "PopVAO","HouseHoldsVAO","BlocksVAO","SavedByVAO","SavedAtVAO",
  "PopSec","HouseHoldsSec","BlocksSec","SavedBySec","SavedAtSec",
  "LastUpdated"
];
// Column index reference (0-based after RowID):
// 0:RowID 1:SNO 2:Code 3:Village 4:RowType 5:Dakale 6:VAO 7:GP
// 8:PopVAO 9:HHsVAO 10:BlksVAO 11:ByVAO 12:AtVAO
// 13:PopSec 14:HHsSec 15:BlksSec 16:BySec 17:AtSec 18:LastUpdated

function doGet(e) {
  var p = e && e.parameter ? e.parameter : {};
  var action = p.action || "read";

  if (action === "ping") {
    return jsonOut({ok:true, msg:"Census 2027 Malavalli ‚Äî Connected!"});
  }

  if (action === "read") {
    return jsonOut(readAll());
  }

  if (action === "write") {
    return jsonOut(writeRow(p));
  }

  return jsonOut({ok:false, error:"Unknown action: " + action});
}

function doPost(e) {
  try {
    var p = JSON.parse(e.postData.contents);
    if (p.action === "write") return jsonOut(writeRow(p));
    return jsonOut({ok:false, error:"Unknown action"});
  } catch(err) {
    return jsonOut({ok:false, error:err.toString()});
  }
}

function jsonOut(obj) {
  var out = ContentService.createTextOutput(JSON.stringify(obj));
  out.setMimeType(ContentService.MimeType.JSON);
  return out;
}

function getSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) {
    sh = ss.insertSheet(SHEET_NAME);
    var hdr = sh.getRange(1, 1, 1, COLS.length);
    hdr.setValues([COLS]);
    hdr.setBackground("#1a3d72").setFontColor("#ffffff")
       .setFontWeight("bold").setFontSize(10);
    sh.setFrozenRows(1);
    sh.setColumnWidth(4, 160); sh.setColumnWidth(6, 160);
    sh.setColumnWidth(7, 130); sh.setColumnWidth(8, 120);
  }
  return sh;
}

function readAll() {
  try {
    var sh = getSheet();
    var data = sh.getDataRange().getValues();
    if (data.length <= 1) return {ok:true, rows:[]};
    var rows = [];
    for (var i = 1; i < data.length; i++) {
      var r = data[i];
      rows.push({
        rowId: r[0], sno: r[1], code: r[2], village: r[3],
        rowType: r[4], dakale: r[5], vao: r[6], gp: r[7],
        popVAO: r[8], hhVAO: r[9], blkVAO: r[10], byVAO: r[11], atVAO: r[12],
        popSec: r[13], hhSec: r[14], blkSec: r[15], bySec: r[16], atSec: r[17],
        updated: r[18]
      });
    }
    return {ok:true, rows:rows, ts: new Date().toISOString()};
  } catch(err) {
    return {ok:false, error:err.toString()};
  }
}

function writeRow(p) {
  try {
    var sh = getSheet();
    var data = sh.getDataRange().getValues();
    var rid = String(p.rowId || "");
    if (!rid) return {ok:false, error:"Missing rowId"};

    // Find existing row
    var targetRow = -1;
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][0]) === rid) { targetRow = i + 1; break; }
    }

    var now = new Date().toLocaleString("en-IN", {timeZone:"Asia/Kolkata"});
    var ex = targetRow > 0 ? data[targetRow-1] : new Array(19).fill("");

    // Build row ‚Äî preserve existing values, only overwrite what's provided
    var row = [
      rid,
      p.sno     || ex[1]  || "",
      p.code    || ex[2]  || "",
      p.village || ex[3]  || "",
      p.rowType || ex[4]  || "",
      p.dakale  !== undefined ? p.dakale : (ex[5] || ""),
      p.vao     || ex[6]  || "",
      p.gp      || ex[7]  || "",
      p.popVAO  !== undefined && p.popVAO !== "" ? p.popVAO : (ex[8]  || ""),
      p.hhVAO   !== undefined && p.hhVAO  !== "" ? p.hhVAO  : (ex[9]  || ""),
      p.blkVAO  !== undefined && p.blkVAO !== "" ? p.blkVAO : (ex[10] || ""),
      p.byVAO   || ex[11] || "",
      p.atVAO   || ex[12] || "",
      p.popSec  !== undefined && p.popSec !== "" ? p.popSec : (ex[13] || ""),
      p.hhSec   !== undefined && p.hhSec  !== "" ? p.hhSec  : (ex[14] || ""),
      p.blkSec  !== undefined && p.blkSec !== "" ? p.blkSec : (ex[15] || ""),
      p.bySec   || ex[16] || "",
      p.atSec   || ex[17] || "",
      now
    ];

    var range;
    if (targetRow > 0) {
      range = sh.getRange(targetRow, 1, 1, row.length);
    } else {
      sh.appendRow(row);
      targetRow = sh.getLastRow();
      range = sh.getRange(targetRow, 1, 1, row.length);
    }

    // Colour rows: dakale = light purple, village = white
    var bg = (String(p.rowType) === "dakale") ? "#f0ebff" : "#ffffff";
    range.setBackground(bg);

    return {ok:true, rowId:rid, row:targetRow};
  } catch(err) {
    return {ok:false, error:err.toString()};
  }
}`;

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  role: null,         // 'vao' | 'sec' | 'adm'
  loginRole: 'vao',
  uname: '',
  url: '',            // Google Sheets Web App URL (resolved at runtime)
  vis: [],            // rows visible to current user
  allRows: [],        // all built rows
  sheetData: {},      // rowId ‚Üí {popVAO,hhVAO,byVAO,atVAO, popSec,hhSec,bySec,atSec}
  syncSt: {},         // rowId ‚Üí 'ok'|'err'|'pending'
  failedQ: [],
  toastT: null
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const show = id => $(id) && $(id).classList.remove('hi');
const hide = id => $(id) && $(id).classList.add('hi');
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function toast(msg, type) {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'show ' + (type||'tok');
  if (S.toastT) clearTimeout(S.toastT);
  S.toastT = setTimeout(() => t.className = '', 3500);
}

function showOv(msg) { $('ov-msg').textContent = msg||'‡≤≤‡≥ã‡≤°‡≥ç ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü‚Ä¶'; show('ov'); }
function hideOv() { hide('ov'); }

// ‚îÄ‚îÄ Build rows from village list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDk(s) {
  if (!s || !s.trim()) return [];
  const m = s.match(/\d+\)\s*([^0-9)]+)/g);
  if (m && m.length > 1) return m.map(x => x.replace(/^\d+\)\s*/, '').trim()).filter(Boolean);
  return [s.trim()];
}

function buildRows(raw) {
  const rows = [];
  raw.forEach(v => {
    const dks = parseDk(v.dk || '');
    rows.push({ ...v, type: 'village', rid: 'V_' + v.code, dkNames: dks });
    dks.forEach((d, i) => rows.push({ ...v, type: 'dakale', rid: 'D_' + v.code + '_' + i, dkName: d }));
  });
  return rows;
}

const getVAOs = () => [...new Set(VILLAGES.map(v => v.vao))].filter(Boolean).sort();
const getGPs  = () => [...new Set(VILLAGES.map(v => (v.gp||'').trim()))].filter(Boolean).sort();

// ‚îÄ‚îÄ Resolve URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resolveUrl() {
  // Priority: BAKED (built into file) > localStorage
  if (BAKED && BAKED !== '__SHEET_URL__') return BAKED;
  return localStorage.getItem('c27_url') || '';
}

// ‚îÄ‚îÄ SHA-256 (Web Crypto) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256',
    new TextEncoder().encode(str + 'C27ML'));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// ‚îÄ‚îÄ Login tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRole(r) {
  S.loginRole = r;
  ['v','s','a'].forEach(x => $('tb-'+x).className = 'rtab');
  $('tb-'+r[0]).className = 'rtab on';
  const isAdm = r === 'adm';
  isAdm ? hide('ng') : show('ng');
  if (!isAdm) {
    $('nlbl').textContent = r === 'vao' ? 'VAO Name' : 'GP Name';
    const sel = $('nsel');
    sel.innerHTML = '<option value="">-- Select --</option>';
    (r === 'vao' ? getVAOs() : getGPs()).forEach(x => {
      const o = document.createElement('option'); o.value = x; o.textContent = x; sel.appendChild(o);
    });
  }
  hide('lerr');
}

function toggleEye() {
  const inp = $('pwd'), btn = $('eyeb');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.textContent = inp.type === 'password' ? 'üëÅ' : 'üôà';
  inp.focus();
}

async function doLogin() {
  const nm = $('nsel').value.trim();
  const pw = $('pwd').value;
  if (!pw) { lerr('Please enter your password'); return; }

  const btn = $('lbtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin-sm"></span>Verifying‚Ä¶';

  const hash = await sha256(pw);

  if (S.loginRole === 'adm') {
    if (hash !== AH) { lerr('Incorrect admin password. Please try again.'); resetBtn(); return; }
    S.role = 'adm'; S.uname = 'Administrator';
    setHdr('‚öô Admin', 'ca', 'Administrator');
    $('pwd').value = '';
    hide('pg-login'); show('pg-admin');
    resetBtn();
    adminLoad();
    return;
  }

  if (!nm) { lerr('Please select your name'); resetBtn(); return; }
  if (hash !== UH) { lerr('Incorrect password. Please try again.'); resetBtn(); return; }

  S.role = S.loginRole; S.uname = nm;
  S.url = resolveUrl();
  S.allRows = buildRows(VILLAGES);
  S.vis = S.role === 'vao'
    ? S.allRows.filter(r => r.vao === nm)
    : S.allRows.filter(r => (r.gp||'').trim() === nm);

  setHdr(S.role==='vao'?'üë§ VAO':'üè¢ Secretary', S.role==='vao'?'cv':'cs', nm);
  $('sb-t').textContent = S.role==='vao' ? 'üë§ VAO Panel' : 'üè¢ Secretary Panel';
  $('sb-n').textContent = nm;
  $('sb-r').textContent = S.role==='vao' ? 'Village Accountant' : 'GP Secretary';
  $('th-gp').textContent = S.role==='vao' ? 'GP Name' : 'VAO';
  $('th-blk').title = '‡≤∏‡≥Å‡≤Æ‡≤æ‡≤∞‡≥Å 700-800 ‡≤ú‡≤®‡≤∞ ‡≤Ö‡≤ß‡≤æ‡≤∞‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¨‡≥ç‡≤≤‡≤æ‡≤ï‡≥ç‚Äå ‡≤Æ‡≤æ‡≤°‡≤¨‡≤π‡≥Å‡≤¶‡≥Å';
  $('th-po').textContent = S.role==='vao' ? 'Population (VAO)' : 'Population (Sec)';
  $('th-hh').textContent = S.role==='vao' ? 'House Holds (VAO)' : 'House Holds (Sec)';
  $('ct-h').textContent  = nm + ' ‚Äî Data Entry';
  $('ct-p').textContent  = S.vis.filter(r=>r.type==='village').length + ' villages ¬∑ Dakale Gramas shown as ‚Ü≥ sub-rows';
  $('pwd').value = '';
  resetBtn();
  hide('pg-login'); show('pg-entry');
  // Fetch all data from Google Sheets on login
  await loadFromSheet();
}

function lerr(msg) { const e=$('lerr'); e.textContent=msg; e.classList.remove('hi'); }
function resetBtn() { const b=$('lbtn'); b.disabled=false; b.textContent='Login ‚Üí'; }

function setHdr(chip, cls, nm) {
  $('hdr-chip').textContent = chip; $('hdr-chip').className = 'chip ' + cls;
  $('hdr-nm').textContent = nm;
  $('hdr-s').style.display = 'flex';
}

function doLogout() {
  S.role = null; S.uname = ''; S.vis = []; S.sheetData = {}; S.syncSt = {}; S.failedQ = [];
  $('hdr-s').style.display = 'none';
  ['pg-entry','pg-admin'].forEach(hide);
  show('pg-login');
  $('nsel').value = ''; $('pwd').value = '';
}

// ‚îÄ‚îÄ SHEET COMMUNICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses no-cors for WRITE (always reaches sheet, no CORS issue)
// Uses fetch with CORS for READ (Apps Script returns JSON with CORS headers)
// On login: fetch all rows ‚Üí populate UI
// On save: write row ‚Üí update UI immediately

async function sheetRead(url) {
  // Apps Script GET with action=read returns JSON with CORS headers
  const r = await fetch(url + '?action=read', { method: 'GET' });
  if (!r.ok) throw new Error('HTTP ' + r.status);
  const ct = r.headers.get('content-type') || '';
  if (ct.includes('text/html')) throw new Error('LOGIN_PAGE');
  return r.json();
}

function sheetWrite(url, params) {
  // no-cors: browser always sends, server receives and writes to sheet
  // We cannot read the response ‚Äî that's OK. We update UI optimistically.
  const qs = Object.keys(params).map(k =>
    encodeURIComponent(k) + '=' + encodeURIComponent(params[k])
  ).join('&');
  return fetch(url + '?action=write&' + qs, { method: 'GET', mode: 'no-cors' });
}

// ‚îÄ‚îÄ Load all data from Sheets on login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromSheet() {
  if (!S.url) {
    hide('pld'); hide('pok'); show('pno');
    updateSyncBar(false);
    showTable(); // show table empty ‚Äî still usable offline
    return;
  }
  show('pld'); hide('pno'); hide('pok');
  $('tld').innerHTML = '<div class="ts"></div><p style="margin-top:12px;color:#64748b">Loading data from Google Sheets‚Ä¶</p>';
  show('tld'); hide('dtbl');

  try {
    const data = await sheetRead(S.url);
    if (!data.ok) throw new Error(data.error || 'Sheet error');
    // Index rows by rowId
    S.sheetData = {};
    (data.rows || []).forEach(r => {
      S.sheetData[r.rowId] = r;
    });
    hide('pld'); show('pok');
    updateSyncBar(true);
    toast('‚úÖ Data loaded from Google Sheets (' + Object.keys(S.sheetData).length + ' rows)');
  } catch(e) {
    hide('pld');
    const msg = e.message || '';
    if (msg === 'LOGIN_PAGE') {
      hide('pok'); show('pno');
      toast('‚ö† Sheet access denied ‚Äî Admin must redeploy with "Who has access: Anyone"', 'twrn');
    } else if (msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
      // No internet ‚Äî still show table with whatever local we have
      hide('pok'); show('pno');
      toast('‚ö† No internet ‚Äî showing previously loaded data', 'twrn');
    } else {
      hide('pok'); show('pno');
      toast('‚ö† Could not load from Sheets: ' + msg, 'twrn');
    }
  }
  showTable();
  updateStats();
}

async function refreshData() {
  if (!S.url) { toast('Google Sheets URL not configured', 'twrn'); return; }
  toast('üîÑ Refreshing from Google Sheets‚Ä¶', 'tinfo');
  await loadFromSheet();
}

// ‚îÄ‚îÄ Render table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTable() {
  hide('tld'); show('dtbl');
  let h = '';
  S.vis.forEach(r => {
    const sd = S.sheetData[r.rid] || {};
    const isV = S.role === 'vao';
    const pv = isV ? (sd.popVAO||'') : (sd.popSec||'');
    const hv = isV ? (sd.hhVAO||'')  : (sd.hhSec||'');
    const saved = pv !== '' || hv !== '';
    const rid = esc(r.rid);
    const isDk = r.type === 'dakale';
    const rowCls = (isDk ? 'dk' : 'vr') + (saved ? ' dn' : '');
    const syn = S.syncSt[r.rid] || '';

    const snoTd = isDk
      ? '<td><span class="darr">‚Ü≥</span></td>'
      : '<td><span class="sno">' + r.sno + '</span></td>';

    const nmTd = isDk
      ? '<td><div class="drow"><div class="dl"></div><span class="dnm">' + esc(r.dkName) + '</span><span class="dbg">DAKALE</span></div></td>'
      : '<td><div class="vn">' + esc(r.name) + '</div>' +
        (r.dkNames && r.dkNames.length ? '<div class="dh">‚Ü≥ ' + r.dkNames.length + ' sub-villages</div>' : '') + '</td>';

    const gpTd = isV
      ? '<td><span class="gpb">' + esc((r.gp||'').trim()) + '</span></td>'
      : '<td style="font-size:12px;color:var(--mut)">' + esc(r.vao||'') + '</td>';

    const dotH = syn
      ? '<span class="rd v ' + (syn==='ok'||syn==='sent'?'rd-ok':syn==='err'?'rd-er':'rd-sp') + '" id="rd-'+rid+'"></span>'
      : '<span class="rd" id="rd-'+rid+'"></span>';

    const actH = saved
      ? dotH + '<button class="bed" onclick="editRow(\'' + rid + '\')">‚úé Edit</button>'
      : dotH + '<button class="bsv" onclick="saveRow(\'' + rid + '\')">Save</button>';

    // Blocks = auto-calc from VAO population (√∑750, rounded)
    const blkPop = parseInt(sd.popVAO||sd.popSec||'0')||0;
    const blkVal = blkPop > 0 ? Math.round(blkPop / 750) : '';
    const blkDisp = sd.blkVAO||sd.blkSec||blkVal||'';
    h += '<tr class="' + rowCls + '" id="tr-' + rid + '">'
      + snoTd
      + '<td><span class="cm">' + r.code + '</span></td>'
      + nmTd + gpTd
      + '<td><input class="ni' + (pv?' ok':'') + '" type="text" inputmode="numeric" id="p-' + rid
        + '" value="' + esc(pv) + '" placeholder="Enter" oninput="onInp(\'' + rid + '\',this)"/></td>'
      + '<td><input class="ni' + (hv?' ok':'') + '" type="text" inputmode="numeric" id="h-' + rid
        + '" value="' + esc(hv) + '" placeholder="Enter" oninput="onInp(\'' + rid + '\',this)"/></td>'
      + '<td><input class="ni blk-ni' + (blkDisp?' ok':'') + '" type="text" inputmode="numeric" id="b-' + rid
        + '" value="' + esc(String(blkDisp)) + '" placeholder="Auto" oninput="onInpB(\'' + rid + '\',this)" title="‡≤∏‡≥Å‡≤Æ‡≤æ‡≤∞‡≥Å 700-800 ‡≤ú‡≤®‡≤∞ ‡≤Ö‡≤ß‡≤æ‡≤∞‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¨‡≥ç‡≤≤‡≤æ‡≤ï‡≥ç‚Äå ‡≤Æ‡≤æ‡≤°‡≤¨‡≤π‡≥Å‡≤¶‡≥Å"/></td>'
      + '<td><div class="act" id="ac-' + rid + '">' + actH + '</div></td>'
      + '</tr>\n';
  });
  $('tbody').innerHTML = h;
  updateStats();
}

function onInpB(rid, el) {
  el.value = el.value.replace(/[^0-9]/g, '');
  const ac = $('ac-' + rid);
  if (ac && !ac.querySelector('.bsv')) {
    ac.innerHTML = '<span class="rd" id="rd-' + rid + '"></span><button class="bsv" onclick="saveRow(\'' + esc(rid) + '\')">Save</button>';
  }
}

function onInp(rid, el) {
  el.value = el.value.replace(/[^0-9]/g, '');
  const ac = $('ac-' + rid);
  if (ac && !ac.querySelector('.bsv')) {
    ac.innerHTML = '<span class="rd" id="rd-' + rid + '"></span><button class="bsv" onclick="saveRow(\'' + esc(rid) + '\')">Save</button>';
  }
}

function editRow(rid) {
  const p = $('p-'+rid), h = $('h-'+rid);
  if(p){p.classList.remove('ok');} if(h){h.classList.remove('ok');}
  $('ac-'+rid).innerHTML = '<span class="rd" id="rd-'+rid+'"></span><button class="bsv" onclick="saveRow(\'' + esc(rid) + '\')">Save</button>';
  if(p) p.focus();
}

// ‚îÄ‚îÄ Save a row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveRow(rid) {
  const pEl = $('p-'+rid), hEl = $('h-'+rid), bEl = $('b-'+rid);
  const pv = (pEl ? pEl.value : '').replace(/[^0-9]/g,'');
  const hv = (hEl ? hEl.value : '').replace(/[^0-9]/g,'');
  // Auto-calculate blocks if not manually entered
  let bv = (bEl ? bEl.value : '').replace(/[^0-9]/g,'');
  if (!bv && pv) bv = String(Math.round(parseInt(pv)/750));
  if (!pv && !hv) { toast('Please enter Population or House Holds value first', 'twrn'); return; }

  const row = S.allRows.find(r => r.rid === rid);
  if (!row) return;

  const now = new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata'});
  const existing = S.sheetData[rid] || {};

  // Build updated record
  const updated = { ...existing };
  if (S.role === 'vao') {
    if (pv) updated.popVAO = pv;
    if (hv) updated.hhVAO  = hv;
    if (bv) updated.blkVAO = bv;
    updated.byVAO = S.uname; updated.atVAO = now;
  } else {
    if (pv) updated.popSec = pv;
    if (hv) updated.hhSec  = hv;
    if (bv) updated.blkSec = bv;
    updated.bySec = S.uname; updated.atSec = now;
  }

  // Update local state immediately (optimistic)
  S.sheetData[rid] = updated;

  // Update UI immediately
  if(pEl){pEl.classList.add('ok');} if(hEl){hEl.classList.add('ok');}
  setDot(rid,'sp');
  const tr = $('tr-'+rid);
  if(tr) tr.className = (row.type==='dakale'?'dk':'vr') + ' dn';
  $('ac-'+rid).innerHTML = '<span class="rd v rd-sp" id="rd-'+rid+'"></span><button class="bed" onclick="editRow(\'' + esc(rid) + '\')">‚úé Edit</button>';
  updateStats();
  toast('üíæ Saved locally ‚Äî syncing to Sheets‚Ä¶', 'tinfo');

  // Write to Google Sheets
  if (!S.url) {
    toast('‚ö† No Sheet URL ‚Äî data saved locally only. Admin must configure Google Sheets.', 'twrn');
    setDot(rid,'er'); S.syncSt[rid]='err'; if(!S.failedQ.includes(rid)) S.failedQ.push(rid);
    updateSyncBar(false); return;
  }

  const params = {
    rowId: rid,
    sno: row.sno, code: row.code, village: row.name,
    rowType: row.type, dakale: row.type==='dakale'?(row.dkName||''):'',
    vao: row.vao||'', gp: row.gp||'',
    popVAO: updated.popVAO||'', hhVAO: updated.hhVAO||'',
    byVAO:  updated.byVAO||'',  atVAO: updated.atVAO||'',
    blkVAO: updated.blkVAO||'',
    popSec: updated.popSec||'', hhSec: updated.hhSec||'',
    bySec:  updated.bySec||'',  atSec: updated.atSec||'',
    blkSec: updated.blkSec||''
  };

  try {
    await sheetWrite(S.url, params);
    // no-cors means we can't read response ‚Äî mark as 'sent' (green)
    S.syncSt[rid] = 'sent';
    S.failedQ = S.failedQ.filter(x => x !== rid);
    setDot(rid,'ok');
    $('ac-'+rid).innerHTML = '<span class="rd v rd-ok" id="rd-'+rid+'"></span><button class="bed" onclick="editRow(\'' + esc(rid) + '\')">‚úé Edit</button>';
    if(bEl && bv){bEl.value=bv; bEl.classList.add('ok');}
    toast('‚òÅ Synced to Google Sheets!');
  } catch(err) {
    S.syncSt[rid] = 'err';
    if(!S.failedQ.includes(rid)) S.failedQ.push(rid);
    setDot(rid,'er');
    toast('‚ö† Could not reach Sheets ‚Äî check internet connection', 'twrn');
  }
  updateStats(); updateSyncBar(!!S.url);
}

function setDot(rid,state){
  const d=$('rd-'+rid); if(!d) return;
  d.className='rd v ' + (state==='ok'||state==='sent'?'rd-ok':state==='er'?'rd-er':'rd-sp');
  d.style.display='inline-block';
}

async function retryFailed() {
  const list = S.failedQ.slice();
  if (!list.length) { toast('No failed rows to retry','tinfo'); return; }
  toast('Retrying ' + list.length + ' rows‚Ä¶','tinfo');
  for (const rid of list) {
    const row = S.allRows.find(r=>r.rid===rid);
    if (row) await saveRow(rid);
  }
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  const total = S.vis.length;
  const vc    = S.vis.filter(r=>r.type==='village').length;
  const isV   = S.role==='vao';
  const done  = S.vis.filter(r => {
    const d = S.sheetData[r.rid]||{};
    return isV ? (d.popVAO||d.hhVAO) : (d.popSec||d.hhSec);
  }).length;
  const synced = S.vis.filter(r => S.syncSt[r.rid]==='sent'||S.syncSt[r.rid]==='ok').length;
  const pct = Math.round(done/Math.max(total,1)*100);

  $('sb-v').textContent  = vc;
  $('sb-tc').textContent = total;
  $('sb-dc').textContent = done+'/'+total;
  $('sb-dc').className   = 'sv '+(done===total?'g':'a');
  $('sb-sc').textContent = S.url ? synced+'/'+done : 'N/A';
  $('pb-p').textContent  = pct+'%';
  $('pf').style.width    = pct+'%';

  if (S.failedQ.length) show('brty'); else hide('brty');
}

function updateSyncBar(connected) {
  const el = $('sst'), t = $('sst-t');
  if (!S.url) {
    el.className='sst sst-no'; t.textContent='Not connected to Sheets';
    el.innerHTML='<span class="dot da"></span><span>Not connected to Google Sheets</span>';
    hide('pok'); show('pno');
  } else if (connected) {
    el.innerHTML='<span class="dot dg"></span><span>‚úì Connected to Google Sheets</span>';
    el.className='sst sst-ok';
    show('pok'); hide('pno');
  } else {
    el.innerHTML='<span class="dot dr"></span><span>Connection issue</span>';
    el.className='sst sst-err';
  }
}

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aTab(n) {
  [0,1].forEach(i=>{$('at'+i).className='atab';$('ap'+i).className='apnl hi';});
  $('at'+n).className='atab on'; $('ap'+n).className='apnl';
  if(n===1) initSetupTab();
}

function initSetupTab() {
  $('sbox').textContent = GS_CODE;
  const url = resolveUrl();
  if(url){ $('ui').value=url; $('ui').className='ui ok'; show('uok'); }
}

function cpScript() {
  const btn=$('cpb');
  const done=()=>{btn.textContent='Copied ‚úì';btn.className='cpb ok';setTimeout(()=>{btn.textContent='Copy';btn.className='cpb';},2500);};
  if(navigator.clipboard){navigator.clipboard.writeText(GS_CODE).then(done).catch(done);}
  else{const ta=document.createElement('textarea');ta.value=GS_CODE;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);done();}
}

function saveUrl() {
  const v=($('ui').value||'').trim();
  if(!v||!v.includes('script.google.com/macros')){
    toast('URL must contain script.google.com/macros ‚Äî check you copied the Web App URL','tbad'); return;
  }
  localStorage.setItem('c27_url',v);
  $('ui').className='ui ok';
  toast('‚úÖ URL saved to this device. Download app to bake it in for all users.');
}

function openTab() {
  const v=($('ui').value||'').trim()||resolveUrl();
  if(!v){toast('Paste URL first','tbad');return;}
  window.open(v+'?action=read','_blank');
}

function markConn() {
  const v=($('ui').value||'').trim()||resolveUrl();
  if(!v){toast('Paste URL first','tbad');return;}
  localStorage.setItem('c27_url',v);
  $('ui').value=v; $('ui').className='ui ok';
  show('uok'); hide('ures');
  toast('‚úÖ Connected! Download the app to deploy for all users.');
}

function dlApp() {
  const url = ($('ui').value||'').trim() || resolveUrl();
  let html = document.documentElement.outerHTML;
  if (url) {
    html = html.replace("const BAKED = '__SHEET_URL__';", "const BAKED = '" + url.replace(/'/g,"\\'") + "';");
    toast('‚úÖ App downloaded with Sheet URL baked in ‚Äî re-upload to GitHub!');
  } else {
    toast('‚ö† No URL configured ‚Äî downloading without Sheet URL. Set up in Step 4 first.','twrn');
  }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download = 'census2027.html';
  a.click();
  URL.revokeObjectURL(a.href);
}

function dlScript() {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([GS_CODE],{type:'text/plain'}));
  a.download = 'census2027_script.gs';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('üìÑ Apps Script file downloaded ‚Äî paste into Google Apps Script editor');
}

// ‚îÄ‚îÄ Admin progress from sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function adminLoad() {
  const url = resolveUrl();
  if(!url){
    $('acards').innerHTML='<div class="ac" style="grid-column:1/-1"><div class="ai">‚ö†</div><div class="av" style="font-size:14px">No Sheet URL configured</div><div class="al">Go to ‚òÅ Sheets Setup tab to connect</div></div>';
    return;
  }
  $('acards').innerHTML='<div class="ac" style="grid-column:1/-1"><div class="ai">‚è≥</div><div class="av" style="font-size:14px">Loading‚Ä¶</div><div class="al">Fetching from Google Sheets</div></div>';
  try {
    const data = await sheetRead(url);
    if(!data.ok) throw new Error(data.error);
    renderAdmin(data.rows||[]);
    $('last-ref').textContent = 'Last updated: ' + new Date().toLocaleTimeString('en-IN');
  } catch(e) {
    $('acards').innerHTML='<div class="ac" style="grid-column:1/-1;background:linear-gradient(135deg,#7f1d1d,#991b1b)"><div class="ai">‚ùå</div><div class="av" style="font-size:13px">Could not load data</div><div class="al">'+esc(e.message)+'</div></div>';
  }
}

function renderAdmin(rows) {
  const allRows = buildRows(VILLAGES);
  const villages = allRows.filter(r=>r.type==='village');
  const total = villages.length;
  // index sheet rows
  const idx = {};
  rows.forEach(r => idx[r.rowId]=r);
  const vDone = villages.filter(r=>{const d=idx[r.rid]||{};return d.popVAO||d.hhVAO;}).length;
  const sDone = villages.filter(r=>{const d=idx[r.rid]||{};return d.popSec||d.hhSec;}).length;
  const vPct = Math.round(vDone/Math.max(total,1)*100);
  const sPct = Math.round(sDone/Math.max(total,1)*100);

  $('acards').innerHTML=`
    <div class="ac"><div class="ai">üèò</div><div class="av">${total}</div><div class="al">Total Villages</div><div class="ach"><div class="acf" style="width:100%"></div></div></div>
    <div class="ac"><div class="ai">üë§</div><div class="av">${vDone}</div><div class="al">VAO Completed (${vPct}%)</div><div class="ach"><div class="acf" style="width:${vPct}%"></div></div></div>
    <div class="ac"><div class="ai">üè¢</div><div class="av">${sDone}</div><div class="al">Secretary Verified (${sPct}%)</div><div class="ach"><div class="acf" style="width:${sPct}%"></div></div></div>
    <div class="ac"><div class="ai">üìä</div><div class="av">${rows.length}</div><div class="al">Rows in Google Sheets</div><div class="ach"><div class="acf" style="width:${Math.round(rows.length/Math.max(allRows.length,1)*100)}%"></div></div></div>
  `;

  // VAO table
  const vaos = getVAOs();
  let vh='';
  vaos.forEach((vao,i)=>{
    const vRows = villages.filter(r=>r.vao===vao);
    const cnt=vRows.length;
    const vC=vRows.filter(r=>{const d=idx[r.rid]||{};return d.popVAO||d.hhVAO;}).length;
    const sC=vRows.filter(r=>{const d=idx[r.rid]||{};return d.popSec||d.hhSec;}).length;
    const pct=Math.round(vC/Math.max(cnt,1)*100);
    const bcls=vC===cnt?'bok':vC>0?'bpt':'bno';
    const btxt=vC===cnt?'Complete':vC>0?'In Progress':'Not Started';
    vh+=`<tr><td>${i+1}</td><td><strong>${esc(vao)}</strong></td><td>${cnt}</td><td>${vC}/${cnt}</td><td>${sC}/${cnt}</td>
      <td><div class="mb"><div class="mf" style="width:${pct}%"></div></div> <span style="font-size:11px;color:var(--mut)">${pct}%</span></td>
      <td><span class="bdg ${bcls}">${btxt}</span></td></tr>`;
  });
  $('vtbody').innerHTML = vh;

  // Village detail table
  let il='';
  villages.forEach((r,i)=>{
    const d=idx[r.rid]||{};
    il+=`<tr><td>${i+1}</td><td><span class="cm">${r.code}</span></td>
      <td><strong>${esc(r.name)}</strong>${r.dkNames&&r.dkNames.length?'<br><span style="font-size:10px;color:#a78bfa">+'+r.dkNames.length+' dakale</span>':''}</td>
      <td style="font-size:12px">${esc(r.vao||'')}</td>
      <td><span class="gpb">${esc((r.gp||'').trim())}</span></td>
      <td style="text-align:right">${d.popVAO||'‚Äî'}</td><td style="text-align:right">${d.hhVAO||'‚Äî'}</td><td style="text-align:right;color:#7c3aed">${d.blkVAO||'‚Äî'}</td>
      <td style="text-align:right">${d.popSec||'‚Äî'}</td><td style="text-align:right">${d.hhSec||'‚Äî'}</td><td style="text-align:right;color:#7c3aed">${d.blkSec||'‚Äî'}</td></tr>`;
  });
  $('iltbody').innerHTML = il;
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setRole('vao');
S.url = resolveUrl();
// Pre-fill URL input if already configured
const _existUrl = resolveUrl();
if(_existUrl && $('ui')){ $('ui').value=_existUrl; $('ui').className='ui ok'; }
</script>
</body>
</html>
